# 3SD-SF-ScrewFeed

## Опис
`xy_cli.py` — це консольний інструмент для керування двома осями (X та Y) через GPIO на Raspberry Pi (під бібліотеку `lgpio`). Скрипт у режимі CLI приймає прості команди для хомінгу, переміщень та джогу, а також дозволяє змінювати кроки/мм і обнуляти поточну позицію. Основна ідея — пряме генерування STEP-пульсів для драйверів осей X/Y із перевіркою кінцевиків (endstop).【F:xy_cli.py†L1-L409】

## Вимоги
- Raspberry Pi з доступом до GPIO.
- Python 3.
- Встановлена бібліотека `lgpio` (скрипт використовує `gpiochip_open`, `gpio_claim_output`, `gpio_read`, `gpio_write`).【F:xy_cli.py†L1-L82】

## Як працює
1. **Мапінг GPIO та логіка сигналів**
   - Вказані піни STEP/DIR/ENA для X та Y, а також входи кінцевиків X_MIN/Y_MIN (активні по LOW).【F:xy_cli.py†L6-L38】
   - ENA активний по HIGH, а STEP-пульс заданий як активний по LOW (common-anode).【F:xy_cli.py†L33-L38】

2. **Генерація STEP-пульсів**
   - Функція `step_pulses` блокує виконання і генерує `steps` імпульсів з обмеженням частоти `MAX_STEP_HZ` та тривалістю імпульсу `PULSE_US`. Якщо задано `stop_on_endstop_gpio`, рух зупиниться при спрацюванні кінцевика.【F:xy_cli.py†L93-L147】

3. **Переміщення по одній осі**
   - `move_axis_abs` рухає одну вісь до абсолютної координати (мм). Кроки/мм множаться на дельту для розрахунку кількості кроків. При русі до мінімуму перевіряється кінцевик та, у разі спрацювання, координата скидається в 0.0 мм.【F:xy_cli.py†L150-L226】

4. **Переміщення по двох осях**
   - `move_xy_abs` виконує інтерливінг кроків X та Y за часом (простий планувальник без синхронного Bresenham). Це дозволяє рухати обидві осі приблизно одночасно з однаковою швидкістю в мм/с.【F:xy_cli.py†L229-L326】

5. **Хомінг**
   - `home_axis` виконує:
     1) від’їзд від кінцевика (якщо вже затиснуто),
     2) швидкий під’їзд до спрацювання,
     3) від’їзд на `backoff_mm`,
     4) повільний під’їзд до точного спрацювання.
   - Після завершення координата осі встановлюється в 0.0 мм.【F:xy_cli.py†L329-L403】

## Налаштування
Ключові константи, які можна змінювати під вашу механіку:
- `STEPS_PER_MM_X`, `STEPS_PER_MM_Y` — кроки на мм для кожної осі.【F:xy_cli.py†L41-L45】
- `X_MIN_MM`, `X_MAX_MM`, `Y_MIN_MM`, `Y_MAX_MM` — межі переміщень у мм.【F:xy_cli.py†L47-L51】
- `MAX_STEP_HZ`, `PULSE_US` — максимальна частота та тривалість STEP-імпульсу.【F:xy_cli.py†L53-L55】
- `ENDSTOP_ACTIVE_LOW`, `ENA_ACTIVE_HIGH`, `STEP_PULSE_ACTIVE_LOW` — логіка сигналів залежно від вашого підключення.【F:xy_cli.py†L33-L38】

## Запуск
```bash
python3 xy_cli.py
```
Після запуску з’явиться запрошення та статус кінцевиків. Драйвери вмикаються автоматично.【F:xy_cli.py†L406-L409】

## Команди CLI
- `HELP` — показати довідку.
- `M114` — поточний статус/координати.
- `M17` / `M18` — увімкнути / вимкнути драйвери.
- `HOME` — хомінг Y, потім X.
- `HOME X` / `HOME Y` — хомінг конкретної осі.
- `G0 X<мм> Y<мм> F<мм/хв>` — абсолютний рух (можна вказати лише X або Y).
- `JX <+/-мм> F<мм/хв>` — джог осі X.
- `JY <+/-мм> F<мм/хв>` — джог осі Y.
- `SET SPMM <val>` — задати кроки/мм для обох осей.
- `SET SPMM X<val> Y<val>` — задати окремо для X/Y.
- `SET X0` / `SET Y0` / `SET XY0` — обнулити поточну позицію.
- `QUIT` — вихід.

Усі ці команди реалізовані в головному циклі `main()` і обробляються текстово (рядки в upper-case).【F:xy_cli.py†L257-L393】

## Приклади
```text
HOME
G0 X50 Y200 F12000
JX -5 F1200
SET SPMM X10 Y10
```

## Зауваження з безпеки
- Скрипт напряму керує драйверами через GPIO, тому переконайтесь у правильності підключень та логіки сигналів перед запуском.
- Вихідні межі (`X_MIN_MM`, `X_MAX_MM`, тощо) використовуються для обмеження координат, але механічні кінцевики все одно повинні бути підключені та перевірені.【F:xy_cli.py†L47-L226】
