# Hardware Connection Guide

## Схема подключения компонентов

```
┌────────────────────────────────────────────────────────────────────────────┐
│                          MASTER Raspberry Pi 5                              │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                            │
│    GPIO Header (40 pins)                                                   │
│    ═══════════════════                                                     │
│                                                                            │
│    3V3  (1)  (2)  5V ──────────────────┬──► Питание датчиков              │
│  GPIO2  (3)  (4)  5V                   │                                   │
│  GPIO3  (5)  (6)  GND ─────────────────┼──► Общая земля                   │
│  GPIO4  (7)  (8)  GPIO14 ──────────────┼──► UART TX → XY Table RX         │
│    GND  (9)  (10) GPIO15 ◄─────────────┼─── UART RX ← XY Table TX         │
│ GPIO17 (11) (12) GPIO18                │                                   │
│ GPIO27 (13) (14) GND                   │                                   │
│ GPIO22 (15) (16) GPIO23                │                                   │
│    3V3 (17) (18) GPIO24                │                                   │
│ GPIO10 (19) (20) GND                   │                                   │
│  GPIO9 (21) (22) GPIO25                │                                   │
│ GPIO11 (23) (24) GPIO8                 │                                   │
│    GND (25) (26) GPIO7                 │                                   │
│  GPIO0 (27) (28) GPIO1                 │                                   │
│  GPIO5 (29) (30) GND                   │                                   │
│  GPIO6 (31) (32) GPIO12                │                                   │
│ GPIO13 (33) (34) GND                   │                                   │
│ GPIO19 (35) (36) GPIO16                │                                   │
│ GPIO26 (37) (38) GPIO20                │                                   │
│    GND (39) (40) GPIO21                │                                   │
│                                        │                                   │
└────────────────────────────────────────┴───────────────────────────────────┘
```

---

## GPIO Распределение Master Pi 5

### Реле (выходы)

| GPIO | Pin | Функция | Описание |
|------|-----|---------|----------|
| 17 | 11 | RELAY_SCREWDRIVER | Питание отвёртки |
| 27 | 13 | RELAY_DIRECTION | Направление вращения |
| 22 | 15 | RELAY_CYL_DOWN | Клапан опускания цилиндра |
| 23 | 16 | RELAY_CYL_UP | Клапан подъёма цилиндра |
| 24 | 18 | RELAY_VACUUM | Вакуумный захват |
| 25 | 22 | RELAY_BLOW | Продувка воздухом |

### Датчики (входы)

| GPIO | Pin | Функция | Описание |
|------|-----|---------|----------|
| 5 | 29 | AREA_SENSOR | Световая завеса безопасности |
| 6 | 31 | ESTOP | Кнопка аварийной остановки |
| 12 | 32 | SCREW_PRESENT | Датчик наличия шурупа |
| 13 | 33 | TORQUE_REACHED | Сигнал достижения момента |
| 19 | 35 | CYL_UP_SENSOR | Цилиндр в верхнем положении |
| 26 | 37 | CYL_DOWN_SENSOR | Цилиндр в нижнем положении |

### UART (связь с XY Table)

| GPIO | Pin | Функция |
|------|-----|---------|
| 14 | 8 | TXD (передача) |
| 15 | 10 | RXD (приём) |

---

## GPIO Распределение XY Table Pi 5

### Ось X

| GPIO | Pin | Функция | Описание |
|------|-----|---------|----------|
| 9 | 21 | X_STEP | Импульсы шагов |
| 10 | 19 | X_DIR | Направление |
| 11 | 23 | X_ENA | Включение драйвера |
| 2 | 3 | X_MIN | Концевик MIN |

### Ось Y

| GPIO | Pin | Функция | Описание |
|------|-----|---------|----------|
| 21 | 40 | Y_STEP | Импульсы шагов |
| 7 | 26 | Y_DIR | Направление |
| 8 | 24 | Y_ENA | Включение драйвера |
| 3 | 5 | Y_MIN | Концевик MIN |

---

## Схема подключения реле

```
                    ┌─────────────────────┐
                    │   RELAY MODULE      │
                    │   (8 channels)      │
                    ├─────────────────────┤
Raspberry Pi 5      │                     │       Load
                    │                     │
GPIO17 ────────────►│ IN1     NO1 ──────►│──── Отвёртка +
GPIO27 ────────────►│ IN2     NO2 ──────►│──── Направление
GPIO22 ────────────►│ IN3     NO3 ──────►│──── Клапан DOWN
GPIO23 ────────────►│ IN4     NO4 ──────►│──── Клапан UP
GPIO24 ────────────►│ IN5     NO5 ──────►│──── Вакуум
GPIO25 ────────────►│ IN6     NO6 ──────►│──── Продувка
                    │                     │
5V ────────────────►│ VCC                 │
GND ───────────────►│ GND    COM ────────►│──── AC/DC Neutral
                    │                     │
                    └─────────────────────┘
```

**Тип реле модуля:** Active HIGH (5V на вход = реле включено)

---

## Схема подключения датчиков

### NPN датчики (active low)

```
                          ┌──────────────┐
         +24V ───────────►│ Brown  (+V)  │
                          │              │
                          │   NPN        │
                          │  Sensor      │
                          │              │
Raspberry Pi GPIO ◄───────│ Black (OUT)  │
                          │              │
         GND  ◄───────────│ Blue  (GND)  │
                          └──────────────┘

Логика: Активен = 0V, Неактивен = Open (подтянут к 3.3V)
```

### Схема подключения с резистором

```
              ┌─────────────────────────────────────────┐
              │                                         │
   3.3V ──────┼─────────┬──────────────────────────────►│ Pull-up
              │         │                               │ (внутренний)
              │        ┌┴┐                              │
              │        │ │ 10kΩ (опционально)           │
              │        │ │                              │
              │        └┬┘                              │
              │         │                               │
              │   ┌─────┴─────┐                         │
              │   │           │                         │
              │   │   NPN     │◄── Детектируемый объект │
              │   │  Sensor   │                         │
              │   │           │                         │
              │   └─────┬─────┘                         │
              │         │                               │
              │         ▼                               │
              │    GPIO Pin ────────────────────────────┘
              │         │
              │         │
   GND  ──────┴─────────┘
```

---

## Схема подключения шаговых двигателей

### Драйвер DM542/TB6600

```
┌──────────────────┐                    ┌──────────────────┐
│   Raspberry Pi   │                    │   DM542 Driver   │
│                  │                    │                  │
│  GPIO9 (STEP) ───┼────────────────────┼──► PUL+          │
│         GND  ────┼────────────────────┼──► PUL-          │
│                  │                    │                  │
│  GPIO10 (DIR) ───┼────────────────────┼──► DIR+          │
│         GND  ────┼────────────────────┼──► DIR-          │
│                  │                    │                  │
│  GPIO11 (ENA) ───┼────────────────────┼──► ENA+          │
│         GND  ────┼────────────────────┼──► ENA-          │
│                  │                    │                  │
│                  │                    │  A+ ────► Мотор  │
│                  │                    │  A- ────► Coil A │
│                  │                    │  B+ ────► Мотор  │
│                  │                    │  B- ────► Coil B │
│                  │                    │                  │
│                  │                    │  VCC ◄── 24-48V  │
│                  │                    │  GND ◄── GND     │
└──────────────────┘                    └──────────────────┘
```

### Настройка микрошага DM542

| SW1 | SW2 | SW3 | Микрошаг | Шагов/об |
|-----|-----|-----|----------|----------|
| ON  | ON  | ON  | 1/2      | 400      |
| OFF | ON  | ON  | 1/4      | 800      |
| ON  | OFF | ON  | 1/8      | 1600     |
| OFF | OFF | ON  | 1/16     | 3200     |

---

## Схема подключения концевиков

### Механический концевик (NC - нормально замкнутый)

```
                    ┌─────────────────────┐
                    │                     │
    3.3V ───────────┤ COM                 │
                    │                     │
                    │    Endstop          │
                    │    (NC)             │
                    │                     │
    GPIO ◄──────────┤ NC                  │
                    │                     │
                    └─────────────────────┘

Логика: Не нажат = HIGH (3.3V), Нажат = LOW (разрыв)
```

### Оптический концевик

```
                    ┌─────────────────────┐
                    │                     │
    5V ─────────────┤ VCC                 │
                    │                     │
    GND ────────────┤ GND                 │
                    │    Optical          │
                    │    Endstop          │
    GPIO ◄──────────┤ OUT                 │
                    │                     │
                    └─────────────────────┘

Логика: Открыт = HIGH, Перекрыт = LOW
```

---

## Питание

### Требования к питанию

| Компонент | Напряжение | Ток |
|-----------|------------|-----|
| Raspberry Pi 5 | 5V | 3A (5A для питания периферии) |
| Шаговые драйверы | 24-48V | 2-4A на ось |
| Реле модуль | 5V | 200mA |
| Датчики NPN | 24V | 50mA общий |
| Пневматика | 24V | 500mA (клапаны) |

### Схема питания

```
              ┌───────────────────────────────────────────────────────┐
              │                      POWER SUPPLY                      │
              │                                                        │
     AC 220V ►│  ┌────────────────┐  ┌────────────────┐              │
     ─────────│──│ 5V 5A PSU      │  │ 24V 5A PSU     │              │
              │  └───────┬────────┘  └───────┬────────┘              │
              │          │ 5V                │ 24V                    │
              │          ▼                   ▼                        │
              │  ┌───────────────┐   ┌───────────────┐               │
              │  │ Raspberry Pi 5│   │ Stepper       │               │
              │  │ (USB-C PD)    │   │ Drivers       │               │
              │  └───────────────┘   └───────────────┘               │
              │          │ 5V                │ 24V                    │
              │          ▼                   ▼                        │
              │  ┌───────────────┐   ┌───────────────┐               │
              │  │ Relay Module  │   │ Sensors       │               │
              │  └───────────────┘   │ Pneumatics    │               │
              │                      └───────────────┘               │
              └───────────────────────────────────────────────────────┘
```

---

## Безопасность

### Рекомендации по проводке

1. **Разделение питания:** Логика (3.3V/5V) и силовая часть (24V/220V) должны быть изолированы
2. **Заземление:** Используйте общую точку заземления для всех GND
3. **Экранирование:** Сигнальные провода STEP/DIR в экране для защиты от помех
4. **Предохранители:** Установите предохранители на каждую линию питания

### Защита GPIO

```
              ┌────────────────────────────────────────┐
              │  Для защиты GPIO от выбросов:          │
              │                                        │
     GPIO ────┤────┬───────────────────────────────────┤
              │    │                                   │
              │   ┌┴┐                                  │
              │   │ │ 1kΩ резистор                     │
              │   └┬┘                                  │
              │    │                                   │
              │    ├───► К датчику/реле               │
              │    │                                   │
              │   ─┴─ Диод защитный (опционально)     │
              │    │                                   │
     GND  ────┤────┴───────────────────────────────────┤
              └────────────────────────────────────────┘
```

---

## Проверка подключения

### Тест GPIO

```bash
# На Raspberry Pi
python3 -c "
import lgpio
h = lgpio.gpiochip_open(0)

# Тест выхода (реле)
lgpio.gpio_claim_output(h, 17, 0)
lgpio.gpio_write(h, 17, 1)  # Включить
lgpio.gpio_write(h, 17, 0)  # Выключить

# Тест входа (датчик)
lgpio.gpio_claim_input(h, 5, lgpio.SET_PULL_UP)
print(f'Sensor: {lgpio.gpio_read(h, 5)}')

lgpio.gpiochip_close(h)
"
```

### Тест UART

```bash
# Loopback тест (соедините TX и RX)
python3 -c "
import serial
s = serial.Serial('/dev/ttyAMA0', 115200, timeout=1)
s.write(b'TEST\n')
print(s.readline())
s.close()
"
```
