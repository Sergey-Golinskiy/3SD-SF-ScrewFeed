# Screw Drive Control System

Система автоматического закручивания шурупов на базе Raspberry Pi 5.

## Архитектура системы

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        Raspberry Pi 5 (MASTER)                          │
│                                                                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌───────────────┐  │
│  │   main.py   │  │  Flask API  │  │   PyQt5 UI  │  │ State Machine │  │
│  │             │──│  (REST)     │  │ (touchdesk) │  │   (cycle)     │  │
│  └─────────────┘  └─────────────┘  └─────────────┘  └───────────────┘  │
│         │                │                │                 │           │
│         └────────────────┴────────────────┴─────────────────┘           │
│                                   │                                     │
│  ┌────────────────────────────────┴──────────────────────────────────┐  │
│  │                         GPIO (lgpio)                              │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────────┐  │  │
│  │  │  Relays  │  │ Sensors  │  │  UART TX │  │  UART RX         │  │  │
│  │  │ (6 ch)   │  │ (6 ch)   │  │  (GPIO14)│  │  (GPIO15)        │  │  │
│  │  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────────┬─────────┘  │  │
│  └───────┼─────────────┼─────────────┼─────────────────┼────────────┘  │
│          │             │             │                 │                │
└──────────┼─────────────┼─────────────┼─────────────────┼────────────────┘
           │             │             │                 │
           ▼             ▼             │                 │
    ┌──────────┐  ┌──────────┐         │                 │
    │ Relays   │  │ Sensors  │         │                 │
    │ Board    │  │ (NPN)    │         │                 │
    └──────────┘  └──────────┘         │                 │
                                       │ Serial UART     │
                                       ▼                 │
                        ┌──────────────────────────────────────────────┐
                        │           Raspberry Pi 5 (XY TABLE)          │
                        │                                              │
                        │  ┌─────────────┐      ┌─────────────────┐   │
                        │  │  xy_cli.py  │◄────►│  GPIO (lgpio)   │   │
                        │  │  --serial   │      │                 │   │
                        │  └─────────────┘      │  X/Y Steppers   │   │
                        │                       │  Endstops       │   │
                        │                       └─────────────────┘   │
                        └──────────────────────────────────────────────┘
```

## Компоненты

### Master Pi 5 (Основной контроллер)

| Компонент | Назначение |
|-----------|------------|
| `main.py` | Точка входа, инициализация системы |
| `core/gpio_controller.py` | Управление GPIO через lgpio |
| `core/relays.py` | Управление реле (отвёртка, пневматика) |
| `core/sensors.py` | Чтение датчиков (безопасность, положение) |
| `core/xy_table.py` | Связь с XY столом через Serial |
| `core/state_machine.py` | Логика цикла автоматизации |
| `api/server.py` | REST API для веб-интерфейса |

### XY Table Pi 5 (Координатный стол)

| Компонент | Назначение |
|-----------|------------|
| `xy_cli.py` | Управление шаговыми двигателями |
| | Работает в режиме `--serial` |
| | Принимает G-code команды |

## Быстрый старт

```bash
# 1. Установка зависимостей
pip install lgpio pyserial flask flask-cors pyyaml

# 2. Запуск на XY Table Pi
python xy_cli.py --serial /dev/ttyAMA0 --baud 115200

# 3. Запуск на Master Pi
cd screwdrive
python main.py

# Или только API сервер
python main.py --api-only --port 5000

# Или CLI режим
python main.py --cli
```

## Документация

- [INSTALLATION.md](INSTALLATION.md) - Полная инструкция по установке
- [PI_TO_PI_CONNECTION.md](PI_TO_PI_CONNECTION.md) - Подключение двух Pi 5
- [API.md](API.md) - Справочник REST API
- [HARDWARE.md](HARDWARE.md) - Схема подключения оборудования

## Команды XY стола

| Команда | Описание |
|---------|----------|
| `PING` | Проверка связи → PONG |
| `G28` | Калибровка всех осей |
| `G X100 Y200 F1000` | Движение в позицию |
| `M112` | Аварийная остановка |
| `M114` | Статус позиции |

## Лицензия

Proprietary - 3SD Project
