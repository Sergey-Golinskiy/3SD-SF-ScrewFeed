# Desktop UI (TouchDesk) — Повний гайд

> **Файл:** `screwdrive/ui/touchdesk.py` (~5300 рядків)
> **Фреймворк:** PyQt6, fullscreen touchscreen інтерфейс
> **Тема:** Темна (dark theme), великі кнопки для тач-панелі

---

## Зміст

1. [Загальна структура](#1-загальна-структура)
2. [Вкладка СТАРТ — Вибір девайсу та ініціалізація](#2-вкладка-старт--вибір-девайсу-та-ініціалізація)
3. [Режим РОБОТА — Цикл закручування](#3-режим-робота--цикл-закручування)
4. [Вкладка КЕРУВАННЯ — Ручне управління столом](#4-вкладка-керування--ручне-управління-столом)
5. [Вкладка СТІЛ — Моніторинг платформи](#5-вкладка-стіл--моніторинг-платформи)
6. [Вкладка ЛОГИ — Системні логи](#6-вкладка-логи--системні-логи)
7. [Вкладка СЕРВІС — Сенсори та реле](#7-вкладка-сервіс--сенсори-та-реле)
8. [Діалогові вікна (помилки / аварії)](#8-діалогові-вікна)
9. [Машина станів (State Machine)](#9-машина-станів)
10. [Анімація рамки](#10-анімація-рамки)

---

## 1. Загальна структура

### Табл панель (5 вкладок)

| # | Назва       | Клас          | Призначення                          |
|---|-------------|---------------|--------------------------------------|
| 0 | СТАРТ/РОБОТА | StartWorkTab  | Вибір девайсу, ініціалізація, цикл   |
| 1 | КЕРУВАННЯ    | ControlTab    | Ручне переміщення XY столу           |
| 2 | СТІЛ        | PlatformTab   | Моніторинг стану XY платформи        |
| 3 | ЛОГИ        | LogsTab       | Перегляд системних логів             |
| 4 | СЕРВІС      | ServiceTab    | Сенсори, реле, мережа               |

### Видимість вкладок

- **За замовчуванням** панель вкладок **прихована** — оператор бачить лише СТАРТ
- **Щоб відкрити** всі вкладки: **утримати педаль 5 секунд** у режимі СТАРТ
- **Щоб сховати**: повторне утримання педалі 5 секунд (повертає на СТАРТ)

```
┌─────────────────────────────────────────────────────────┐
│ [СТАРТ] [КЕРУВАННЯ] [СТІЛ] [ЛОГИ] [СЕРВІС]  ← прихо- │
│                                                вані    │
│                                                         │
│                   Вміст вкладки                         │
│                                                         │
└─────────────────────────────────────────────────────────┘
      ↑ рамка пульсує жовтим у СТАРТ / зеленим у READY
```

---

## 2. Вкладка СТАРТ — Вибір девайсу та ініціалізація

### Призначення
Головний робочий екран оператора. Тут обирається девайс з каталогу груп і запускається ініціалізація машини.

### Як зайти
- Відкривається автоматично при запуску програми
- Повертається після натискання СТОП у режимі РОБОТА
- Повертається після аварійної зупинки (E-STOP)

### Як вийти
- Після успішної ініціалізації → автоматичний перехід у РОБОТА
- Утримання педалі 5с → доступ до інших вкладок

### Макет екрану

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│  ┌──────────────────┐  ┌──────────────────────────────────────────┐ │
│  │  Вибір девайсу    │  │  Статус                                  │ │
│  │                   │  │                                          │ │
│  │  ┌──────────────┐ │  │  Девайс: DEV-001                        │ │
│  │  │ Група A (3)  │ │  │  Таска: 2     Момент: 2.5 Nm            │ │
│  │  ├──────────────┤ │  │  Оснастка: FIX-01                       │ │
│  │  │ Група B (5)  │ │  │                                          │ │
│  │  ├──────────────┤ │  │  Девайс DEV-001 вибрано.                 │ │
│  │  │ Група C (2)  │ │  │  Натисніть ІНІЦІАЛІЗАЦІЯ.               │ │
│  │  ├──────────────┤ │  │                                          │ │
│  │  │ Без групи(1) │ │  │  ░░░░░░░░░░░░░░░░░░  0%                │ │
│  │  └──────────────┘ │  └──────────────────────────────────────────┘ │
│  │                   │                                               │
│  │  ← Скрол         │  ┌──────────────────────────────────────────┐ │
│  │                   │  │                                          │ │
│  └──────────────────┘  │          ІНІЦІАЛІЗАЦІЯ                    │ │
│       33% ширини       │          (велика кнопка)                  │ │
│                        │                                          │ │
│                        └──────────────────────────────────────────┘ │
│                              66% ширини                             │
└─────────────────────────────────────────────────────────────────────┘
```

### Після натискання на групу → список девайсів

```
┌──────────────────┐
│  ◀  Група A      │  ← кнопка "Назад" (назва групи)
│                   │
│  ┌──────────────┐ │
│  │ DEV-001  (5) │ │  ← ключ девайсу + кількість гвинтів
│  ├──────────────┤ │
│  │ DEV-002  (8) │ │
│  ├──────────────┤ │
│  │ DEV-003  (3) │ │
│  └──────────────┘ │
│                   │
└──────────────────┘
```

### User Flow

```
┌─────────┐    ┌─────────────┐    ┌──────────────┐    ┌────────────┐
│ Каталог │───→│ Вибір групи │───→│ Вибір девайсу│───→│ ІНІЦІАЛ-ЦІЯ│
│  груп   │    │             │    │              │    │  (кнопка)  │
└─────────┘    └─────────────┘    └──────────────┘    └─────┬──────┘
                                                            │
                    ┌───────────────────────────────────────┘
                    ▼
              ┌───────────┐     ┌─────────┐
              │ Ініціал-  │────→│ РОБОТА  │   (автоматичний перехід)
              │ ізація... │ OK  │  режим  │
              │ ████░░ 60%│     └─────────┘
              └─────┬─────┘
                    │ FAIL
                    ▼
              ┌───────────┐
              │ Помилка!  │───→ Повертає на СТАРТ
              │ (діалог)  │
              └───────────┘
```

### Умови та перевірки

| Перевірка                  | Що відбувається при невиконанні                                |
|---------------------------|---------------------------------------------------------------|
| Девайс не вибрано         | Кнопка ІНІЦІАЛІЗАЦІЯ неактивна                                |
| Оснастка не призначена    | Кнопка ІНІЦІАЛІЗАЦІЯ неактивна, червоний текст попередження    |
| Web UI виконує операцію   | Повідомлення "Web UI виконує операцію. Зачекайте..."          |
| E-STOP натиснуто          | Ініціалізація зупиняється, діалог аварійної зупинки           |
| QR код не відскановано    | Діалог помилки → повернення на СТАРТ                          |
| QR код не співпадає       | Діалог невідповідності → повернення на СТАРТ                  |
| Аларм драйвера           | Автоматична перезавантаження драйвера (до 3 спроб)            |

### Кроки ініціалізації (13+ кроків)

```
 0%  ┬─ Перевірка алармів драйверів (power cycle якщо знайдено)
     ├─ Перевірка E-STOP
     ├─ Перевірка підключення XY столу
     ├─ Скидання стану E-STOP (M999, до 3 спроб)
     ├─ Увімкнення степперів (M17)
25%  ├─ Відпускання гальм (r02, r03 = ON)
     ├─ PING slave Raspberry Pi
     ├─ Перевірка циліндра (повинен бути вгорі)
50%  ├─ Хомінг осі Y
     ├─ Хомінг осі X
     ├─ Тест циліндра (пульс 500мс вниз-вгору)
75%  ├─ Сканування QR коду оснастки (до 3 спроб)
     ├─ Встановлення реле задачі (r07, r08)
100% └─ Переміщення до позиції оператора
```

---

## 3. Режим РОБОТА — Цикл закручування

### Призначення
Виконання циклу автоматичного закручування гвинтів. Оператор натискає СТАРТ і спостерігає за прогресом.

### Як зайти
- Автоматичний перехід після успішної ініціалізації
- Відновлення стану при перезапуску програми (якщо був RUNNING/READY)

### Як вийти
- Кнопка СТОП → повернення на СТАРТ
- Завершення циклу → залишається в РОБОТА (можна запустити ще)
- E-STOP → повернення на СТАРТ через діалог

### Макет екрану

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│  DEV-001          Циклів: 5 (32.4с)    Гвинтів: 3/8   Оснаст: FIX│
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │  Закручується гвинт 3 / 8...                                   ││
│  │  ████████████░░░░░░░░░░  37%                                   ││
│  └─────────────────────────────────────────────────────────────────┘│
│                                                                     │
│  ┌───────────────────────────────────┐  ┌────────────────────────┐ │
│  │                                   │  │                        │ │
│  │                                   │  │                        │ │
│  │         СТАРТ                     │  │        СТОП            │ │
│  │      ЗАКРУЧУВАННЯ                 │  │                        │ │
│  │      (зелена кнопка)              │  │    (червона кнопка)    │ │
│  │                                   │  │                        │ │
│  │         65% ширини                │  │     35% ширини         │ │
│  │                                   │  │                        │ │
│  └───────────────────────────────────┘  └────────────────────────┘ │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### User Flow — Цикл закручування

```
┌─────────┐    ┌──────────────────┐    ┌───────────────────────┐
│  READY  │───→│  СТАРТ натиснуто │───→│  Камера почала запис  │
│         │    │  або педаль       │    │  CycleWorker запущено │
└─────────┘    └──────────────────┘    └───────────┬───────────┘
                                                   │
                          ┌────────────────────────┘
                          ▼
                ┌───────────────────┐
                │   Для кожного     │
                │   кроку (step):   │
                │                   │
                │  FREE → рух       │
                │  WORK → закруч.   │◄─────────┐
                └────────┬──────────┘          │
                         │                     │
              ┌──────────┼──────────┐          │
              ▼          ▼          ▼          │
        ┌──────────┐ ┌────────┐ ┌────────┐    │
        │  Подача  │ │ Момент │ │ Завіса │    │
        │  гвинта  │ │ не     │ │ спрац. │    │
        │  не      │ │ досяг. │ │        │    │
        │  вдалась │ │        │ │        │    │
        └────┬─────┘ └───┬────┘ └───┬────┘    │
             │           │          │          │
             ▼           ▼          ▼          │
        ┌────────┐  ┌────────┐ ┌────────┐     │
        │Діалог: │  │Діалог: │ │Діалог: │     │
        │Продовж.│  │Вилучіть│ │Зона    │     │
        │або     │  │девайс  │ │безпечна│     │
        │Вилучити│  │        │ │        │     │
        └──┬──┬──┘  └───┬────┘ └───┬────┘     │
     Retry │  │Remove   │         │           │
           │  │         │         │           │
           │  ▼         ▼         ▼           │
           │ START   START      START         │
           │ режим   режим     режим          │
           │                                  │
           └──────────────────────────────────┘

        ╔═════════════════════════╗
        ║  Усі гвинти закручено  ║──→ COMPLETED
        ║  Камера зупинена       ║    (залиш. в РОБОТА)
        ║  Запис в історію       ║    Кнопка СТАРТ знову
        ╚═════════════════════════╝    активна
```

### Процес закручування одного гвинта

```
    Подача гвинта          Опускання          Закручування
    ┌──────────┐          ┌──────────┐        ┌──────────┐
    │ r01_pit  │──3 спр.─→│ r06_pot  │──ON──→ │ Чекаємо  │
    │ пульс    │          │ момент   │        │ do2_ok   │
    │ чекаємо  │          │ r04_c2   │        │ ACTIVE   │
    │ ind_scrw │          │ циліндр  │        │ (до 2с)  │
    └──────────┘          └──────────┘        └────┬─────┘
                                                   │ OK
                                                   ▼
                                             ┌──────────┐
                                             │ r06 OFF  │
                                             │ r04 OFF  │
                                             │ r05 пульс│
                                             │ чек. цил.│
                                             │ вгору    │
                                             └──────────┘
```

### Запис відео

- **Початок:** при натисканні СТАРТ ЗАКРУЧУВАННЯ
- **Кінець:** при завершенні циклу (або помилці)
- **Перейменування файлу:** `{device}_{timestamp}_OK.avi` / `_FAIL.avi` / `_ESTOP.avi`
- **Збереження в історії:** шлях файлу зберігається в записі історії

---

## 4. Вкладка КЕРУВАННЯ — Ручне управління столом

### Призначення
Сервісна вкладка для ручного переміщення XY столу, хомінгу, управління гальмами. Використовується інженером для налагодження.

### Як зайти
- Утримати педаль 5 секунд → відкриваються вкладки → вибрати "КЕРУВАННЯ"

### Як вийти
- Вибрати іншу вкладку
- Утримати педаль 5с для приховування вкладок

### Макет екрану

```
┌─────────────────────────────────────────────────────────────────────┐
│  [СТАРТ]  [КЕРУВАННЯ]  [СТІЛ]  [ЛОГИ]  [СЕРВІС]                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────────────────┐  ┌──────────────────────────────────┐ │
│  │  Позиція                 │  │  Хомінг                          │ │
│  │                          │  │                                  │ │
│  │  X: 150.25   Y: 200.00  │  │  ┌──────────┐  ┌──────┐┌──────┐ │ │
│  │  Робочі: X: 50.25       │  │  │  ХОМІНГ  │  │ХОМ X ││ХОМ Y │ │ │
│  │          Y: 100.00       │  │  │  (повний)│  │      ││      │ │ │
│  │                          │  │  └──────────┘  └──────┘└──────┘ │ │
│  └──────────────────────────┘  │                                  │ │
│                                │  ┌──────────┐  ┌──────────────┐  │ │
│  ┌──────────────────────────┐  │  │ В роб. 0 │  │До оператора  │  │ │
│  │  Джог                    │  │  └──────────┘  └──────────────┘  │ │
│  │                          │  └──────────────────────────────────┘ │
│  │       ┌─────┐            │                                      │
│  │       │ Y-  │            │  ┌──────────────────────────────────┐ │
│  │       └─────┘            │  │  Гальма                          │ │
│  │  ┌─────┐   ┌─────┐      │  │                                  │ │
│  │  │ X-  │   │ X+  │      │  │  Гальмо X:  [  ON  ]            │ │
│  │  └─────┘   └─────┘      │  │  Гальмо Y:  [  OFF ]            │ │
│  │       ┌─────┐            │  │                                  │ │
│  │       │ Y+  │            │  └──────────────────────────────────┘ │
│  │       └─────┘            │                                      │
│  │                          │  ┌──────────────────────────────────┐ │
│  │  Крок: [10mm ▼]          │  │                                  │ │
│  │  Подача:[5000 ▼]         │  │            СТОП                  │ │
│  │                          │  │        (червона)                 │ │
│  └──────────────────────────┘  └──────────────────────────────────┘ │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### Функціонал

| Елемент          | Дія                                                    |
|-----------------|--------------------------------------------------------|
| Y-, Y+, X-, X+ | Джог (інкрементальне переміщення) на обраний крок       |
| Крок (ComboBox) | 0.1 / 0.5 / 1 / 5 / 10 / 50 мм                       |
| Подача (ComboBox)| 1000 / 3000 / 5000 / 10000 / 20000 / 30000 / 50000 мм/хв |
| ХОМІНГ          | Повний хомінг (Y потім X)                              |
| ХОМ X / ХОМ Y   | Хомінг окремої осі                                    |
| В роб. 0        | Переміщення в робочий нуль (offset point)              |
| До оператора    | Переміщення до позиції оператора                       |
| Гальмо X/Y     | Перемикач ON/OFF (ON = гальмо відпущене)               |
| СТОП            | Аварійна зупинка XY столу (E-STOP + Stop)             |

### Умови

- Кнопки блокуються під час руху (`_buttons_locked = True`)
- ХОМ X вимагає попереднього хомінгу Y
- При натисканні СТОП — надсилається `xy_estop()` + `xy_stop()`

---

## 5. Вкладка СТІЛ — Моніторинг платформи

### Призначення
Читання стану XY платформи в реальному часі: позиція, підключення, стан хомінгу, лог комунікації зі slave.

### Як зайти
- Вкладки відкриті → вибрати "СТІЛ"

### Макет екрану

```
┌─────────────────────────────────────────────────────────────────────┐
│  [СТАРТ]  [КЕРУВАННЯ]  [СТІЛ]  [ЛОГИ]  [СЕРВІС]                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────────┐ ┌──────────────────┐ ┌──────────────────────┐ │
│  │ Статус XY Столу  │ │ Позиція          │ │ Slave Raspberry Pi   │ │
│  │                  │ │                  │ │                      │ │
│  │ Стан:     Idle   │ │ Фізична:         │ │ Статус:   Connected  │ │
│  │ Підключ.: Так    │ │ X: 150.25        │ │ Останній             │ │
│  │ Homed: X:T Y:T   │ │ Y: 200.00        │ │ зв'язок: 12:34:56   │ │
│  │ Endstops: -      │ │                  │ │ Помилка:  -          │ │
│  │                  │ │ Робоча:           │ │                      │ │
│  │                  │ │ X: 50.25         │ │                      │ │
│  │                  │ │ Y: 100.00        │ │                      │ │
│  │                  │ │                  │ │                      │ │
│  │                  │ │ Offset:           │ │                      │ │
│  │                  │ │ X: 100.00        │ │                      │ │
│  │                  │ │ Y: 100.00        │ │                      │ │
│  └──────────────────┘ └──────────────────┘ └──────────────────────┘ │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │ Лог XY Столу та Slave                                          ││
│  │                                                                 ││
│  │ [12:34:56] [INFO] [GCODE] G1 X150.25 Y200.00 F5000            ││
│  │ [12:34:55] [INFO] [COMM] PONG received                        ││
│  │ [12:34:54] [INFO] [RELAY] r04_c2 = OFF                        ││
│  │ [12:34:53] [DEBUG] [SENSOR] ger_c2_up = ACTIVE                ││
│  │ ...                                                             ││
│  │                                                    (100 рядків) ││
│  └─────────────────────────────────────────────────────────────────┘│
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### Автооновлення
- Позиції та стан: кожну секунду (через основний `refresh()`)
- XY лог: кожні 2 секунди
- Slave IP: кожні 30 секунд

---

## 6. Вкладка ЛОГИ — Системні логи

### Призначення
Перегляд і фільтрація системних логів з кольоровим кодуванням рівнів.

### Як зайти
- Вкладки відкриті → вибрати "ЛОГИ"

### Макет екрану

```
┌─────────────────────────────────────────────────────────────────────┐
│  [СТАРТ]  [КЕРУВАННЯ]  [СТІЛ]  [ЛОГИ]  [СЕРВІС]                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  Категорія: [Всі    ▼]  Рівень: [Всі   ▼]  [🔄 Авто] [Оновити]   │
│                                                                     │
│  Записів: 142                     Оновлено: 12:34:56               │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │ [12:35:00] [ERROR]   [CYCLE]  Torque not reached on hole 5     ││
│  │ [12:34:58] [WARNING] [SENSOR] alarm_x detected                 ││
│  │ [12:34:56] [INFO]    [GCODE]  G1 X150 Y200 F5000              ││
│  │ [12:34:55] [INFO]    [RELAY]  r04_c2 = ON                     ││
│  │ [12:34:54] [DEBUG]   [COMM]   PING sent                       ││
│  │ ...                                                             ││
│  │                                                   (до 200 рядк) ││
│  └─────────────────────────────────────────────────────────────────┘│
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### Кольорове кодування

| Рівень  | Колір    |
|---------|----------|
| ERROR   | Червоний (#eb5757) |
| WARNING | Жовтий   (#f2c94c) |
| INFO    | Світло-сірий (#e0e0e0) |
| DEBUG   | Приглушений сірий (#808080) |

### Фільтри

- **Категорія:** Всі, XY, COMM, GCODE, SYSTEM, CYCLE, RELAY, SENSOR
- **Рівень:** Всі, DEBUG, INFO, WARNING, ERROR
- **Автооновлення:** перемикач (кожні 3 секунди)
- **Ручне оновлення:** кнопка "Оновити"

---

## 7. Вкладка СЕРВІС — Сенсори та реле

### Призначення
Діагностична вкладка для перегляду стану всіх сенсорів та ручного керування реле.

### Як зайти
- Вкладки відкриті → вибрати "СЕРВІС"

### Макет екрану

```
┌─────────────────────────────────────────────────────────────────────┐
│  [СТАРТ]  [КЕРУВАННЯ]  [СТІЛ]  [ЛОГИ]  [СЕРВІС]                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │ Мережа                                                          ││
│  │                                                                 ││
│  │ IP адреса: 192.168.1.100 [⟳]   API: ● Онлайн                  ││
│  │ Slave IP: 192.168.1.101  [⟳]                                   ││
│  └─────────────────────────────────────────────────────────────────┘│
│                                                                     │
│  ┌───────────────────────┐  ┌──────────────────────────────────────┐│
│  │ Сенсори               │  │ Реле керування                       ││
│  │                       │  │                                      ││
│  │ ┌───────┐┌───────┐┌──┐│  │ ┌──────┐┌──────┐┌──────┐┌──────┐┌──┐││
│  │ │E-STOP ││Цил.   ││  ││  │ │Подача││Гальм.││Гальм.││Цилінд││  │││
│  │ │       ││вгорі  ││  ││  │ │      ││X     ││Y     ││р     ││  │││
│  │ │INACTIVE│ACTIVE ││  ││  │ │[OFF] ││[ON]  ││[ON]  ││[OFF] ││  │││
│  │ └───────┘└───────┘└──┘│  │ └──────┘└──────┘└──────┘└──────┘└──┘││
│  │ ┌───────┐┌───────┐┌──┐│  │                                      ││
│  │ │Цил.   ││Гвинт  ││  ││  │ ┌──────┐┌──────┐┌──────┐┌──────┐┌──┐││
│  │ │внизу  ││       ││  ││  │ │Вільн.││Момент││Задача││Задача││  │││
│  │ │       ││       ││  ││  │ │хід   ││      ││0     ││1     ││  │││
│  │ │INACTIVE│INACTIVE│  ││  │ │[OFF] ││[OFF] ││[OFF] ││[OFF] ││  │││
│  │ └───────┘└───────┘└──┘│  │ └──────┘└──────┘└──────┘└──────┘└──┘││
│  │ ┌───────┐┌───────┐┌──┐│  │                                      ││
│  │ │Момент ││Аларм  ││  ││  │                                      ││
│  │ │OK     ││X      ││  ││  │                                      ││
│  │ │INACTIVE│INACTIVE│  ││  │                                      ││
│  │ └───────┘└───────┘└──┘│  │                                      ││
│  └───────────────────────┘  └──────────────────────────────────────┘│
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### Сенсори (9 шт.)

| Ключ            | Назва UI    | Що показує                          |
|-----------------|-------------|-------------------------------------|
| emergency_stop  | E-STOP      | Кнопка аварійної зупинки            |
| ger_c2_up       | Цил.вгорі   | Геркон: циліндр у верхній позиції   |
| ger_c2_down     | Цил.внизу   | Геркон: циліндр у нижній позиції    |
| ind_scrw        | Гвинт       | Індуктивний: гвинт подано           |
| do2_ok          | Момент OK   | Момент закручування досягнуто       |
| alarm_x         | Аларм X     | Аларм драйвера осі X               |
| alarm_y         | Аларм Y     | Аларм драйвера осі Y               |
| ped_start       | Педаль      | Педаль запуску натиснута             |
| area_sensor     | Завіса      | Світлова завіса (безпека зони)      |

**Кольори:** ACTIVE = зелений фон | INACTIVE = темний фон

### Реле (10 шт.)

| Ключ            | Назва UI    | Призначення                         |
|-----------------|-------------|-------------------------------------|
| r01_pit         | Подача      | Пульс подачі гвинта                |
| r02_brake_x     | Гальмо X   | Гальмо осі X (ON = відпущене)      |
| r03_brake_y     | Гальмо Y   | Гальмо осі Y (ON = відпущене)      |
| r04_c2          | Циліндр     | Пневматичний циліндр вниз/вгору     |
| r05_di4_free    | Вільн.хід   | Пульс вільного ходу шпинделя        |
| r06_di1_pot     | Момент      | Режим моменту (потенціометр)        |
| r07_di5_tsk0    | Задача 0    | Біт 0 вибору задачі                |
| r08_di6_tsk1    | Задача 1    | Біт 1 вибору задачі                |
| r09_pwr_x       | Живл. X     | Живлення драйвера X                |
| r10_pwr_y       | Живл. Y     | Живлення драйвера Y                |

**Кнопки:** кожне реле має перемикач ON/OFF

---

## 8. Діалогові вікна

Всі діалоги — **повноекранні**, без рамки, поверх всіх вікон.

### 8.1 E-STOP (Аварійна зупинка)

```
┌─────────────────────────────────────────┐
│                                         │
│            ⛔  СТОП                      │
│                                         │
│       АВАРІЙНА ЗУПИНКА!                 │
│                                         │
│   Відпустіть кнопку для продовження     │
│   Потрібна переініціалізація!           │
│                                         │
│         (червоний фон)                  │
│    Закривається автоматично при          │
│    відпусканні кнопки E-STOP            │
│                                         │
└─────────────────────────────────────────┘
```

**Тригер:** Сенсор `emergency_stop` = ACTIVE
**Дії:** Зупинка всіх процесів, вимкнення циліндра, моменту. Гальма відпускаються (ON) щоб оператор міг зсунути стіл вручну.
**Вихід:** Автоматично при відпусканні кнопки → повернення на СТАРТ

### 8.2 QR невідповідність

```
┌─────────────────────────────────────────┐
│                                         │
│         ⚠️  НЕВІДПОВІДНІСТЬ QR!          │
│                                         │
│   Очікувалось: FIX-001_ABC123          │
│   Відскановано: FIX-002_XYZ789         │
│                                         │
│   Встановіть правильну оснастку        │
│   та повторіть ініціалізацію.          │
│                                         │
│              [   OK   ]                 │
│                                         │
└─────────────────────────────────────────┘
```

**Тригер:** QR код оснастки не співпадає з очікуваним
**Вихід:** Натискання OK → повернення на СТАРТ

### 8.3 QR не відскановано

```
┌─────────────────────────────────────────┐
│                                         │
│         ⚠️  QR КОД НЕ ВІДСКАНОВАНО!     │
│                                         │
│   Не вдалося зчитати QR код оснастки.  │
│   Перевірте чи оснастка встановлена    │
│   та QR код доступний для сканера.     │
│                                         │
│              [   OK   ]                 │
│                                         │
└─────────────────────────────────────────┘
```

**Тригер:** 3 невдалі спроби сканування QR
**Вихід:** OK → повернення на СТАРТ

### 8.4 Гвинт не подано

```
┌─────────────────────────────────────────┐
│                                         │
│         ⚠️  ГВИНТ НЕ ПОДАНО!            │
│                                         │
│   Можливі причини:                     │
│   • Бункер порожній                    │
│   • Гвинт застряг                      │
│   • Подавач заблокований               │
│                                         │
│  ┌─────────────────┐ ┌───────────────┐  │
│  │   ПРОДОВЖИТИ    │ │   ДІСТАТИ     │  │
│  │  ЗАКРУЧУВАННЯ   │ │    ДЕВАЙС     │  │
│  │   (зелена)      │ │  (червона)    │  │
│  └─────────────────┘ └───────────────┘  │
│                                         │
└─────────────────────────────────────────┘
```

**Тригер:** 3 невдалі спроби подачі гвинта (r01_pit + ind_scrw)
**"ПРОДОВЖИТИ":** повторна спроба подачі (розблокує CycleWorker)
**"ДІСТАТИ ДЕВАЙС":** зупинка циклу → повернення на СТАРТ

### 8.5 Світлова завіса

```
┌─────────────────────────────────────────┐
│                                         │
│         ⚠️  СВІТЛОВА ЗАВІСА!             │
│                                         │
│   Закручування зупинено.               │
│   Приберіть руки з робочої зони.       │
│                                         │
│   Потрібна переініціалізація!          │
│                                         │
│         [  ЗОНА БЕЗПЕЧНА  ]             │
│                                         │
└─────────────────────────────────────────┘
```

**Тригер:** Сенсор `area_sensor` = ACTIVE під час циклу
**Дії:** Циліндр вгору, момент OFF, вільний хід, мотори OFF
**Вихід:** "ЗОНА БЕЗПЕЧНА" → повернення на СТАРТ (потрібна переініціалізація)

### 8.6 Момент не досягнуто

```
┌─────────────────────────────────────────┐
│                                         │
│      🔧  МОМЕНТ НЕ ДОСЯГНУТО!           │
│                                         │
│   Гвинт не закручено.                  │
│   Дістаньте недокручений девайс.       │
│                                         │
│       [  ДЕВАЙС ВИЛУЧЕНО  ]             │
│                                         │
└─────────────────────────────────────────┘
```

**Тригер:** Сенсор `do2_ok` не став ACTIVE за 2 секунди
**Дії:** Циліндр вгору, момент OFF, вільний хід, стіл повертається до оператора
**Вихід:** "ДЕВАЙС ВИЛУЧЕНО" → стан READY (можна запустити новий цикл)

---

## 9. Машина станів

### Діаграма переходів

```
                    ┌──────────────────────────────────────────┐
                    │                                          │
                    │         E-STOP (в будь-якому стані)      │
                    │         ──────────────────────────→       │
                    │                                  ┌───────┤
                    │                                  │E-STOP │
                    │                                  │       │
                    │                                  └───┬───┘
                    │                                      │
                    │                   відпущена кнопка   │
                    │                                      ▼
┌───────┐   вибір девайсу    ┌──────────────┐         ┌───────┐
│       │──────────────────→ │ INITIALIZING │         │       │
│ IDLE  │                    │              │         │ СТАРТ │
│       │ ◄──── помилка ──── │  (progress)  │         │ режим │
└───────┘                    └──────┬───────┘         └───────┘
    ▲                               │
    │                          OK   │
    │                               ▼
    │                        ┌──────────┐     СТАРТ       ┌─────────┐
    │                        │  READY   │───────────────→  │ RUNNING │
    │                        │          │◄────────────────  │         │
    │                        └──────────┘    COMPLETED     └────┬────┘
    │                             ▲                             │
    │                             │  "ДЕВАЙС ВИЛУЧЕНО"         │
    │                             │                    ┌───────┴───────┐
    │                        ┌────┴──────┐             │               │
    │                        │  TORQUE   │         ┌───┴───┐     ┌────┴────┐
    │                        │  ERROR    │         │ AREA  │     │  FEED   │
    │                        └───────────┘         │BLOCKED│     │  ERROR  │
    │                                              └───┬───┘     └────┬────┘
    │                                                  │              │
    │                           СТАРТ режим            │   СТАРТ     │
    └──────────────────────────────────────────────────┴──────────────┘

    ┌─────────┐
    │ STOPPED │───→ СТАРТ режим (через кнопку СТОП)
    └─────────┘
```

### Стани та їх значення

| Стан           | Де відображається | Значення                                    |
|----------------|-------------------|---------------------------------------------|
| IDLE           | СТАРТ режим       | Девайс не вибрано, очікування               |
| INITIALIZING   | СТАРТ режим       | Виконується ініціалізація (13+ кроків)      |
| READY          | РОБОТА режим      | Ініціалізація завершена, можна запускати     |
| RUNNING        | РОБОТА режим      | Цикл закручування виконується               |
| COMPLETED      | РОБОТА режим      | Цикл успішно завершено                      |
| TORQUE_ERROR   | РОБОТА + діалог   | Момент не досягнуто                         |
| AREA_BLOCKED   | Діалог            | Спрацювала світлова завіса                  |
| FEED_ERROR     | Діалог            | Подача гвинта не вдалась                    |
| STOPPED        | Перехідний        | Оператор натиснув СТОП                      |
| E-STOP         | Діалог            | Аварійна зупинка                            |
| ERROR          | РОБОТА режим      | Загальна помилка циклу                      |

---

## 10. Анімація рамки

Головне вікно має кольорову рамку, що відображає поточний стан:

| Стан                | Рамка                                       |
|---------------------|---------------------------------------------|
| СТАРТ режим (IDLE)  | Жовтий пульс (дихання, 2с цикл)            |
| INITIALIZING        | Жовтий пульс                                |
| RUNNING             | Оранжевий (суцільний)                       |
| COMPLETED           | Зелений (суцільний)                         |
| ERROR / TORQUE / AREA / FEED | Червоний (суцільний)              |
| E-STOP              | Червоний (суцільний)                        |

```
Анімація пульсу (СТАРТ режим):

  яскравість
    1.0 ─      ╱╲        ╱╲        ╱╲
    0.75─     ╱  ╲      ╱  ╲      ╱  ╲
    0.5 ─    ╱    ╲    ╱    ╲    ╱    ╲
    0.25─   ╱      ╲  ╱      ╲  ╱      ╲
    0.0 ─ ──        ──        ──        ──
          ├── ~2с ──┤
```

---

## Загальна карта навігації

```
╔══════════════════════════════════════════════════════════════════════╗
║                                                                      ║
║   Запуск програми                                                    ║
║        │                                                             ║
║        ▼                                                             ║
║   ┌──────────┐     (педаль 5с)     ┌────────────────────────────┐    ║
║   │  СТАРТ   │ ◄─────────────────→ │ Панель вкладок (5 вкладок)│    ║
║   │  (IDLE)  │     (педаль 5с)     │                            │    ║
║   └────┬─────┘                     │ ┌──────────┐               │    ║
║        │                           │ │КЕРУВАННЯ │ Джог, хомінг  │    ║
║   Вибір групи                      │ │          │ гальма, стоп  │    ║
║        │                           │ └──────────┘               │    ║
║        ▼                           │ ┌──────────┐               │    ║
║   Вибір девайсу                    │ │  СТІЛ    │ XY стан,     │    ║
║        │                           │ │          │ позиції, лог  │    ║
║        ▼                           │ └──────────┘               │    ║
║   ІНІЦІАЛІЗАЦІЯ                    │ ┌──────────┐               │    ║
║        │                           │ │  ЛОГИ    │ Фільтрація,  │    ║
║   OK   │   FAIL                    │ │          │ рівні, авто   │    ║
║        ▼     ▼                     │ └──────────┘               │    ║
║   ┌────────┐ діалог                │ ┌──────────┐               │    ║
║   │ РОБОТА │ помилки               │ │ СЕРВІС   │ Сенсори,     │    ║
║   │ (READY)│                       │ │          │ реле, мережа  │    ║
║   └────┬───┘                       │ └──────────┘               │    ║
║        │                           └────────────────────────────┘    ║
║   СТАРТ ЗАКРУЧУВАННЯ                                                ║
║   (кнопка або педаль)                                                ║
║        │                                                             ║
║        ▼                                                             ║
║   ┌──────────┐                                                       ║
║   │ RUNNING  │──── OK ────→ COMPLETED (залишається в РОБОТА)         ║
║   │          │──── FAIL ──→ Діалог помилки → СТАРТ або READY         ║
║   │          │──── СТОП ──→ СТАРТ режим                              ║
║   └──────────┘                                                       ║
║                                                                      ║
║   ⚡ E-STOP доступний ЗАВЖДИ → діалог → СТАРТ режим                  ║
║                                                                      ║
╚══════════════════════════════════════════════════════════════════════╝
```

---

## Серверна синхронізація

Desktop UI постійно синхронізує стан із сервером:

| Подія                    | Дія                                     |
|--------------------------|----------------------------------------|
| Вибір девайсу            | `select_device(key)` + `set_ui_state()` |
| Початок ініціалізації    | `set_ui_state(INITIALIZING)`            |
| Прогрес ініціалізації    | `set_ui_state()` з відсотком            |
| Початок циклу            | `set_ui_state(RUNNING)` + запис камери  |
| Прогрес циклу            | `set_ui_state()` з гвинтами/відсотком   |
| Завершення циклу         | `set_ui_state(COMPLETED)` + зупинка камери + історія |
| Помилка                  | `set_ui_state(ERROR/TORQUE/AREA/FEED)`  |
| E-STOP                   | `set_ui_state(E-STOP)` + `xy_estop()`  |
| СТОП                     | `set_ui_state(STOPPED)` + `xy_stop()`   |

**Джерело оновлень:** `source: "desktop"` (Web UI використовує `source: "web"`)

**Відновлення при перезапуску:** `_restore_state_from_server()` — якщо цикл був RUNNING, стан стає PAUSED
