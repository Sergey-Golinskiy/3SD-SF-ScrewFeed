# 3SD-SF-ScrewFeed - Документація системи

## Огляд проекту

**3SD-SF-ScrewFeed** - автоматизована система для закручування гвинтів з XY-координатним столом. Система побудована на двох Raspberry Pi 5:
- **Master Pi** - основний контролер (керування циклом, датчики, реле, API)
- **Slave Pi** - контролер XY столу (крокові мотори, кінцевики)

### Основні можливості
- Автоматичне позиціонування за XY координатами
- Послідовне закручування гвинтів за програмою
- Контроль моменту закручування
- Захисні блокування (світлова завіса, аварійна кнопка)
- Веб-інтерфейс та десктоп-інтерфейс
- Налаштування девайсів (програм закручування)
- USB-камера з відеозаписом та MJPEG стрімінгом
- Сканер штрих-кодів для ідентифікації деталей (fixtures)
- USB-накопичувач для зберігання відеозаписів

---

## Структура документації

| Документ | Опис |
|----------|------|
| [ARCHITECTURE.md](ARCHITECTURE.md) | Архітектура системи та структура коду |
| [HARDWARE.md](HARDWARE.md) | Апаратні підключення (GPIO, датчики, реле) |
| [XY_TABLE.md](XY_TABLE.md) | Система керування XY столом |
| [SCREWDRIVER.md](SCREWDRIVER.md) | Система керування шуруповертом |
| [USER_INTERFACE.md](USER_INTERFACE.md) | Інтерфейси користувача (Web UI, Desktop UI) |
| [USER_FLOW.md](USER_FLOW.md) | Сценарії використання (User Flow) для всіх ролей |
| [WORK_CYCLE.md](WORK_CYCLE.md) | Робочий цикл та логіка роботи |
| [API.md](API.md) | REST API документація |
| [CONFIGURATION.md](CONFIGURATION.md) | Довідник по конфігурації системи |
| [INSTALLATION.md](INSTALLATION.md) | Інструкція з встановлення |
| [DEPLOY_PULL_GUIDE.md](DEPLOY_PULL_GUIDE.md) | Інструкція з оновлення коду на сервері |
| [SPLASH_SETUP_UA.md](SPLASH_SETUP_UA.md) | Налаштування Splash Screen |

---

## Швидкий старт

### Запуск на Master Raspberry Pi 5
```bash
cd /home/user/3SD-SF-ScrewFeed/screwdrive
pip install -r requirements.txt
python main.py --api-only --port 5000
```

### Запуск на Slave Raspberry Pi 5 (XY стіл)
```bash
cd /home/user/3SD-SF-ScrewFeed
pip install lgpio pyserial
python3 xy_cli.py --serial /dev/ttyAMA0 --baud 115200
```

### Доступ до веб-інтерфейсу
```
http://<master-pi-ip>:5000
```

---

## Архітектура системи

```
┌─────────────────────────────────────────────────────────────┐
│                    MASTER RASPBERRY PI 5                     │
├─────────────────────────────────────────────────────────────┤
│  main.py                                                     │
│  ├─ GPIOController (lgpio)     - керування GPIO             │
│  ├─ RelayController            - 10 реле                    │
│  ├─ SensorController           - 9 датчиків                 │
│  ├─ XYTableController          - зв'язок з XY столом        │
│  ├─ CycleStateMachine          - логіка циклу               │
│  ├─ USBCamera                  - відеозапис та стрімінг     │
│  ├─ BarcodeScanner             - сканування штрих-кодів     │
│  ├─ USBStorage                 - зовнішній USB-накопичувач  │
│  └─ Flask API Server           - REST API + Web UI          │
│                                                              │
│  UI:                                                         │
│  ├─ Web UI (index.html, app.js) - браузерний інтерфейс     │
│  └─ Desktop UI (touchdesk.py)   - PyQt5 інтерфейс          │
└────────────────────────┬────────────────────────────────────┘
                         │ UART Serial (/dev/ttyAMA0, 115200)
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                    SLAVE RASPBERRY PI 5                      │
├─────────────────────────────────────────────────────────────┤
│  xy_cli.py --serial /dev/ttyAMA0                            │
│  ├─ GPIO (lgpio)               - пряме керування GPIO       │
│  ├─ Stepper Motors (X/Y)       - крокові мотори            │
│  ├─ Endstops (X_MIN, Y_MIN)    - кінцевики                 │
│  └─ E-STOP button              - апаратна аварійна кнопка  │
└─────────────────────────────────────────────────────────────┘
```

---

## Основні компоненти

### Апаратне забезпечення
- **XY координатний стіл** - 220×500 мм робоча область
- **Шуруповерт** - з контролем моменту
- **Пневматичний циліндр** - опускання/підняття шуруповерта
- **Подавач гвинтів** - автоматична подача
- **Світлова завіса** - захист робочої зони
- **Аварійна кнопка** - екстрене зупинення

### Програмне забезпечення
- **Python 3.10+** - основна мова
- **Flask** - веб-сервер
- **PyQt5** - десктоп інтерфейс
- **lgpio** - робота з GPIO на Raspberry Pi 5

---

## Робочий цикл (коротко)

1. **Вибір девайсу** - оператор вибирає програму
2. **Ініціалізація** - хомінг, перевірка датчиків
3. **Цикл закручування**:
   - Переміщення до позиції (FREE або WORK)
   - Подача гвинта (імпульс R01)
   - Опускання циліндра (R04 ON)
   - Закручування до моменту (R06 ON, очікування DO2_OK)
   - Підняття циліндра (R04 OFF)
4. **Завершення** - повернення до оператора

---

## Безпека

### Захисні блокування
- **Аварійна кнопка (E-STOP)** - негайне зупинення всіх операцій
- **Світлова завіса** - зупинка при перетині зони
- **Аларми драйверів** - зупинка при збої мотора
- **Таймаути** - захист від зависання операцій

### Критичні датчики
| Датчик | GPIO | Функція |
|--------|------|---------|
| emergency_stop | 27 | Аварійна кнопка (active HIGH) |
| area_sensor | 17 | Світлова завіса (active LOW) |
| alarm_x | 2 | Аларм драйвера X |
| alarm_y | 3 | Аларм драйвера Y |

---

## Контакти та підтримка

Проект розроблено для автоматизації процесу закручування гвинтів.

**Версія документації:** 1.1
**Дата оновлення:** Лютий 2026
