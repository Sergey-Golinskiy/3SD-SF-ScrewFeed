# Робочий цикл та логіка роботи

## Огляд процесу

Система працює у двох основних фазах:
1. **Ініціалізація** - підготовка машини до роботи
2. **Робочий цикл** - послідовне закручування гвинтів

---

## Фаза 1: Ініціалізація

### Послідовність кроків

| Крок | Дія | Прогрес | Таймаут |
|------|-----|---------|---------|
| 0 | Перевірка алармів драйверів | 2% | - |
| 0.1 | Перевірка E-STOP | 5% | - |
| 0.2 | Перевірка підключення XY | 10% | - |
| 0.3 | Скидання E-STOP (M999) | 11% | 15с |
| 0.4 | Увімкнення моторів (M17) | 12% | 15с |
| 1 | Розблокування гальм | 15% | 300мс |
| 1.1 | Хомінг XY столу | 25% | 60с |
| 2 | Тест датчиків циліндра | 35% | 5с |
| 3 | Опускання циліндра (тест) | 50% | 5с |
| 4 | Підняття циліндра | 60% | 5с |
| 5 | Вибір задачі (R07/R08) | 75% | 700мс |
| 6 | Рух до оператора | 85% | 30с |
| ✓ | Готово | 100% | - |

### Відновлення алармів

При виявленні аларму на будь-якому кроці:

```
1. Вимкнути живлення драйвера (1 секунда)
2. Увімкнути живлення драйвера
3. Очікування 500мс стабілізації
4. Перезапуск ініціалізації з початку
5. Максимум 3 спроби
```

### Помилки ініціалізації

| Помилка | Причина | Рішення |
|---------|---------|---------|
| "E-STOP натиснуто" | Кнопка натиснута | Відпустити кнопку |
| "XY стіл не підключено" | Немає з'єднання | Перевірити кабель |
| "Хомінг не вдався" | Кінцевик не знайдено | Перевірити кінцевики |
| "Циліндр не в позиції" | Немає тиску | Перевірити пневматику |
| "Аларм драйвера" | Збій мотора | Перезапуск системи |

---

## Фаза 2: Робочий цикл

### Структура циклу

```
Початок циклу
    │
    ▼
┌───────────────────────────┐
│ Для кожного кроку в steps │
└───────────┬───────────────┘
            │
            ▼
    ┌───────────────┐
    │ type = FREE ? │──Так──► Швидке переміщення
    └───────┬───────┘              │
            │ Ні                   │
            ▼                      │
    ┌───────────────┐              │
    │ type = WORK ? │──Так──► Цикл закручування
    └───────┬───────┘              │
            │                      │
            ▼                      ▼
    ┌───────────────────────────────┐
    │ Перевірка: area_sensor,       │
    │            алармів            │
    └───────────────┬───────────────┘
                    │
                    ▼
            Наступний крок
                    │
                    ▼
    ┌───────────────────────────────┐
    │ Всі кроки виконано?           │
    └───────────────┬───────────────┘
                    │ Так
                    ▼
    ┌───────────────────────────────┐
    │ Повернення до оператора       │
    └───────────────────────────────┘
```

### Крок FREE (швидке переміщення)

```python
def execute_free_step(step):
    # 1. Перевірка безпеки
    check_area_sensor()
    check_driver_alarms()

    # 2. Рух до позиції
    xy_move(step.x, step.y, step.feed)
    wait_for_move()

    # 3. Продовження
    return SUCCESS
```

### Крок WORK (закручування)

```python
def execute_work_step(step, hole_number):
    # 1. Рух до позиції
    xy_move(step.x, step.y, step.feed)
    wait_for_move()

    # 2. Подача гвинта (до 3 спроб)
    for attempt in range(3):
        pulse("r01_pit", 0.2)
        if wait_for_sensor("ind_scrw", "ACTIVE", 1.0):
            break
        check_driver_alarms()
    else:
        raise Error("Гвинт не виявлено")

    # 3. Увімкнути режим моменту
    set("r06_di1_pot", "on")

    # 4. Опустити циліндр
    set("r04_c2", "on")
    wait_for_sensor("ger_c2_down", "ACTIVE", 3.0)

    # 5. Очікування моменту
    if not wait_for_sensor("do2_ok", "ACTIVE", 2.0):
        raise Error("TORQUE_NOT_REACHED")

    # 6. Вимкнути режим моменту
    set("r06_di1_pot", "off")

    # 7. Підняти циліндр
    set("r04_c2", "off")
    wait_for_sensor("ger_c2_up", "ACTIVE", 5.0)

    # 8. Free run імпульс
    pulse("r05_di4_free", 0.2)

    return SUCCESS
```

### Таймлайн одного закручування

```
Час (с)   0        1        2        3        4        5
          │        │        │        │        │        │
Рух XY    ████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
Подача    ░░░░░░░░█░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
R06       ░░░░░░░░░░██████████████████░░░░░░░░░░░░░░░░░
R04       ░░░░░░░░░░░░░░██████████████░░░░░░░░░░░░░░░░░
Циліндр↓  ░░░░░░░░░░░░░░░░░░██████████░░░░░░░░░░░░░░░░░
do2_ok    ░░░░░░░░░░░░░░░░░░░░░░░░░░██░░░░░░░░░░░░░░░░░
Циліндр↑  ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░████████░░░░░░░
R05 pulse ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░█░░░░░░
```

---

## Обробка помилок

### TORQUE_NOT_REACHED

**Умова:** do2_ok не ACTIVE за 2 секунди

**Послідовність відновлення:**
```
1. Вимкнути R06 (режим моменту)
2. Вимкнути R04 (підняти циліндр)
3. Очікування ger_c2_up (5с)
4. Імпульс R05 (free run, 200мс)
5. Рух до позиції оператора (work_x, work_y)
6. Стан = PAUSED
7. Повідомлення: "Момент не досягнуто. Перевірте гвинт."
8. Очікування натискання СТАРТ для продовження
```

### AREA_BLOCKED

**Умова:** area_sensor став ACTIVE під час роботи

**Послідовність відновлення:**
```
1. Негайна зупинка руху
2. Вимкнути R04 (підняти циліндр)
3. Вимкнути R06 (режим моменту)
4. Імпульс R05 (300мс)
5. Вимкнути мотори XY (M18)
6. Стан = AREA_BLOCKED
7. Показати діалог "СВІТЛОВА ЗАВІСА!"
8. Очікування підтвердження безпеки
9. Потрібна повна переініціалізація
```

### DRIVER_ALARM

**Умова:** alarm_x або alarm_y став ACTIVE

**Послідовність відновлення (під час init):**
```
1. Power cycle драйвера (1 секунда)
2. Перезапуск ініціалізації
3. Максимум 3 спроби
```

**Послідовність відновлення (під час циклу):**
```
1. Аварійна зупинка XY (3 спроби)
2. Вимкнути R04, R06
3. Стан = ERROR
4. Повідомлення: "АВАРІЯ ДРАЙВЕРА! Вийміть деталь."
5. Потрібна повна переініціалізація
```

### XY_MOVE_ERROR

**Умова:** xy_status.state = 'error' або 'estop'

**Послідовність відновлення:**
```
1. Зупинка циклу
2. Стан = ERROR
3. Повідомлення: "Помилка XY столу"
4. Потрібна переініціалізація
```

---

## Машина станів

### Діаграма станів

```
                    ┌─────────┐
                    │  IDLE   │
                    └────┬────┘
                         │ Start Init
                         ▼
                    ┌─────────┐
               ┌────│ HOMING  │────┐
               │    └────┬────┘    │
           Error│        │Success  │E-STOP
               │         ▼         │
               │    ┌─────────┐    │
               │    │  READY  │    │
               │    └────┬────┘    │
               │         │ Start   │
               │         │ Cycle   │
               │         ▼         │
               │ ┌───────────────┐ │
               │ │ MOVING_FREE   │ │
               │ └───────┬───────┘ │
               │         │         │
               │         ▼         │
               │ ┌───────────────┐ │
               │ │ MOVING_WORK   │ │
               │ └───────┬───────┘ │
               │         │         │
               │         ▼         │
               │ ┌───────────────┐ │
               │ │   LOWERING    │ │
               │ └───────┬───────┘ │
               │         │         │
               │         ▼         │
               │ ┌───────────────┐ │
               │ │   SCREWING    │─┤ Torque Error
               │ └───────┬───────┘ │
               │         │         │
               │         ▼         │
               │ ┌───────────────┐ │
               │ │   RAISING     │ │
               │ └───────┬───────┘ │
               │         │         │
               │         ▼         │
               │ ┌───────────────┐ │
               │ │More steps?    │ │
               │ └───────┬───────┘ │
               │     Yes │   │ No  │
               │         │   │     │
               │    ┌────┘   └────┐│
               │    │             ││
               │    ▼             ▼│
               │ MOVING_FREE  ┌─────────┐
               │              │COMPLETED│
               │              └─────────┘
               │
               ▼
          ┌─────────┐           ┌─────────┐
          │  ERROR  │           │  ESTOP  │
          └─────────┘           └─────────┘
```

### Опис станів

| Стан | Опис | Наступний |
|------|------|-----------|
| IDLE | Система в очікуванні | HOMING (init) |
| HOMING | Виконується хомінг | READY або ERROR |
| READY | Готовий до роботи | MOVING_FREE (start) |
| MOVING_FREE | Швидке переміщення | MOVING_WORK або завершення |
| MOVING_WORK | Рух до точки закручування | LOWERING |
| LOWERING | Опускання циліндра | SCREWING |
| SCREWING | Закручування гвинта | RAISING або ERROR |
| RAISING | Підняття циліндра | MOVING_FREE або COMPLETED |
| COMPLETED | Цикл завершено | IDLE |
| PAUSED | Пауза (помилка моменту) | MOVING_WORK (retry) |
| ERROR | Критична помилка | IDLE (reinit) |
| ESTOP | Аварійна зупинка | IDLE (reinit) |

---

## Формат програми девайсу

### YAML структура

```yaml
devices:
  - key: "MCO_BACK_M3x10"
    name: "MCO"
    what: "Задня панель"
    holes: 4
    screw_size: "M3x10"
    task: "0"
    torque: 0.8
    work_x: 50.0
    work_y: 100.0
    work_feed: 5000
    program:
      - { type: "free", x: 5.0, y: 10.0, f: 60000 }
      - { type: "work", x: 50.0, y: 100.0, f: 30000 }
      - { type: "work", x: 80.0, y: 100.0, f: 30000 }
      - { type: "work", x: 110.0, y: 100.0, f: 30000 }
      - { type: "work", x: 140.0, y: 100.0, f: 30000 }
```

### Поля девайсу

| Поле | Тип | Опис |
|------|-----|------|
| key | string | Унікальний ідентифікатор |
| name | string | Назва (4 символи) |
| what | string | Опис деталі |
| holes | int | Кількість гвинтів (1-12) |
| screw_size | string | Розмір гвинта |
| task | string | Задача шуруповерта (0-3) |
| torque | float | Момент (0-1 Nm) |
| work_x | float | X позиція оператора |
| work_y | float | Y позиція оператора |
| work_feed | float | Швидкість до оператора |
| program | array | Масив кроків |

### Типи кроків

**FREE - швидке переміщення:**
```yaml
{ type: "free", x: 5.0, y: 10.0, f: 60000 }
```
- Рух без закручування
- Висока швидкість
- Датчик area_sensor перевіряється

**WORK - закручування:**
```yaml
{ type: "work", x: 50.0, y: 100.0, f: 30000 }
```
- Рух + повний цикл закручування
- Нижча швидкість для точності
- Всі датчики перевіряються

---

## Безпека

### Блокування руху

Рух заборонено якщо:
- E-STOP натиснуто
- area_sensor заблокований
- Осі не захомлені
- Аларм драйвера активний

### Моніторинг під час руху

Перевіряється на кожному кроці:
- Апаратний E-STOP
- Світлова завіса
- Аларми драйверів

### Критичні датчики

| Датчик | Реакція |
|--------|---------|
| emergency_stop | Негайна зупинка всього |
| area_sensor | Зупинка циклу, вимкнення моторів |
| ger_c2_down (неочікувано) | Негайно R04 OFF |
| alarm_x / alarm_y | Power cycle драйвера |

---

## Таймінги

### Ініціалізація

| Операція | Таймаут |
|----------|---------|
| Скидання E-STOP | 15с |
| Увімкнення моторів | 15с |
| Хомінг | 60с на вісь |
| Тест циліндра | 5с |
| Рух до оператора | 30с |

### Робочий цикл

| Операція | Таймаут |
|----------|---------|
| Рух XY | 30с |
| Подача гвинта | 1с на спробу |
| Опускання циліндра | 3с |
| Досягнення моменту | 2с |
| Підняття циліндра | 5с |

### Тривалості імпульсів

| Операція | Тривалість |
|----------|------------|
| Подача гвинта (R01) | 200мс |
| Вибір задачі (R07/R08) | 700мс |
| Free run імпульс (R05) | 200мс |
| Скидання E-STOP (R05) | 300мс |

---

## User Flow

### Типовий сценарій роботи

```
1. Оператор запускає систему
   └─ Web UI або Desktop UI

2. Вибір девайсу
   └─ Клік на девайс у списку

3. Натискання "ІНІЦІАЛІЗАЦІЯ"
   ├─ Система виконує хомінг
   ├─ Тест циліндра
   └─ Рух до оператора

4. Встановлення деталі
   └─ Оператор кладе деталь на стіл

5. Натискання "СТАРТ"
   ├─ Система закручує всі гвинти
   └─ Повертається до оператора

6. Зняття деталі
   └─ Оператор знімає готову деталь

7. Повторення (крок 4)
```

### Сценарій помилки моменту

```
1. Під час закручування момент не досягнуто
   └─ Таймаут 2 секунди

2. Система:
   ├─ Піднімає циліндр
   ├─ Повертається до оператора
   └─ Показує повідомлення

3. Оператор:
   ├─ Перевіряє гвинт
   └─ Натискає "СТАРТ" для продовження

4. Система продовжує з того ж гвинта
```

### Сценарій світлової завіси

```
1. Під час роботи перетнута зона безпеки
   └─ area_sensor ACTIVE

2. Система негайно:
   ├─ Зупиняє рух
   ├─ Піднімає циліндр
   ├─ Вимикає мотори
   └─ Показує попередження

3. Оператор:
   ├─ Забирає руки із зони
   └─ Натискає "ЗОНА БЕЗПЕЧНА"

4. Потрібна повна переініціалізація
```
