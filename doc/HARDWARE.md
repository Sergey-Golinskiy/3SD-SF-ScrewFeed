# Апаратне забезпечення 3SD-SF-ScrewFeed

## Загальна схема системи

```
┌────────────────────────────────────────────────────────────────────┐
│                         MASTER RASPBERRY PI 5                       │
├────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  GPIO Виходи (Реле):                GPIO Входи (Датчики):          │
│  ├─ GPIO 5  → R01 (подавач)         ├─ GPIO 2  ← Аларм X          │
│  ├─ GPIO 6  → R02 (гальмо X)        ├─ GPIO 3  ← Аларм Y          │
│  ├─ GPIO 13 → R03 (гальмо Y)        ├─ GPIO 17 ← Світлова завіса  │
│  ├─ GPIO 16 → R04 (циліндр)         ├─ GPIO 18 ← Педаль старту    │
│  ├─ GPIO 19 → R05 (free run)        ├─ GPIO 22 ← Циліндр вгорі    │
│  ├─ GPIO 20 → R06 (момент)          ├─ GPIO 23 ← Циліндр внизу    │
│  ├─ GPIO 21 → R07 (задача 0)        ├─ GPIO 12 ← Датчик гвинта    │
│  ├─ GPIO 26 → R08 (задача 1)        ├─ GPIO 25 ← Момент OK        │
│  ├─ GPIO 4  → R09 (живлення X)      └─ GPIO 27 ← E-STOP кнопка    │
│  └─ GPIO 24 → R10 (живлення Y)                                     │
│                                                                     │
│  UART (/dev/ttyAMA0):                                              │
│  └─ TX/RX → до Slave Pi (115200 baud)                              │
│                                                                     │
└────────────────────────────────────────────────────────────────────┘
                              │
                              │ UART Serial (115200 baud)
                              ▼
┌────────────────────────────────────────────────────────────────────┐
│                         SLAVE RASPBERRY PI 5                        │
├────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  X-Axis Driver:                    Y-Axis Driver:                  │
│  ├─ GPIO 9  → X_STEP               ├─ GPIO 21 → Y_STEP             │
│  ├─ GPIO 10 → X_DIR                ├─ GPIO 7  → Y_DIR              │
│  └─ GPIO 11 → X_ENA                └─ GPIO 8  → Y_ENA              │
│                                                                     │
│  Endstops:                         E-STOP:                         │
│  ├─ GPIO 2  ← X_MIN                └─ GPIO 13 ← Hardware E-STOP    │
│  └─ GPIO 3  ← Y_MIN                                                │
│                                                                     │
└────────────────────────────────────────────────────────────────────┘
```

---

## Master Raspberry Pi 5 - GPIO призначення

### Реле (виходи)

**Всі реле: Active LOW** (GPIO LOW = реле ON, GPIO HIGH = реле OFF)

| Реле | GPIO | Назва | Функція | Примітки |
|------|------|-------|---------|----------|
| R01 | 5 | r01_pit | Подавач гвинтів | Імпульс 200мс для подачі гвинта |
| R02 | 6 | r02_brake_x | Гальмо мотора X | ON=розблоковано, OFF=заблоковано |
| R03 | 13 | r03_brake_y | Гальмо мотора Y | ON=розблоковано, OFF=заблоковано |
| R04 | 16 | r04_c2 | Циліндр | ON=вниз, OFF=вгору |
| R05 | 19 | r05_di4_free | Вільне обертання | Тримати ON для обертання |
| R06 | 20 | r06_di1_pot | Режим моменту | Тримати ON до досягнення моменту |
| R07 | 21 | r07_di5_tsk0 | Вибір задачі 0 | Імпульс 700мс |
| R08 | 26 | r08_di6_tsk1 | Вибір задачі 1 | Імпульс 700мс |
| R09 | 4 | r09_pwr_x | Живлення драйвера X | **Інвертовано**: OFF=живлення ON |
| R10 | 24 | r10_pwr_y | Живлення драйвера Y | **Інвертовано**: OFF=живлення ON |

### Датчики (входи)

**Pull-up резистори увімкнено на всіх входах**

| Датчик | GPIO | Active | Логіка | Функція |
|--------|------|--------|--------|---------|
| alarm_x | 2 | LOW | 0 = ACTIVE | Сигнал аларму драйвера X |
| alarm_y | 3 | LOW | 0 = ACTIVE | Сигнал аларму драйвера Y |
| area_sensor | 17 | LOW | 0 = ACTIVE | Світлова завіса (зона заблокована) |
| ped_start | 18 | LOW | 0 = ACTIVE | Педаль старту натиснута |
| ger_c2_up | 22 | LOW | 0 = ACTIVE | Циліндр у верхній позиції |
| ger_c2_down | 23 | LOW | 0 = ACTIVE | Циліндр внизу (АВАРІЯ!) |
| ind_scrw | 12 | LOW | 0 = ACTIVE | Гвинт виявлено в трубці |
| do2_ok | 25 | LOW | 0 = ACTIVE | Момент закручування досягнуто |
| emergency_stop | 27 | **HIGH** | 1 = ACTIVE | E-STOP кнопка натиснута |

### Дебаунсинг датчиків

| Датчик | Дебаунс | Примітка |
|--------|---------|----------|
| area_sensor | 100мс | Фільтрація шумів |
| emergency_stop | 50мс | Швидка реакція |
| Інші | 10мс | Стандартний |

---

## Slave Raspberry Pi 5 - GPIO призначення

### Драйвер осі X

| Сигнал | GPIO | Напрямок | Опис |
|--------|------|----------|------|
| X_STEP | 9 | Вихід | Імпульс кроку |
| X_DIR | 10 | Вихід | Напрямок (HIGH/LOW) |
| X_ENA | 11 | Вихід | Enable (HIGH = увімкнено) |
| X_MIN | 2 | Вхід | Кінцевик MIN позиції |

### Драйвер осі Y

| Сигнал | GPIO | Напрямок | Опис |
|--------|------|----------|------|
| Y_STEP | 21 | Вихід | Імпульс кроку |
| Y_DIR | 7 | Вихід | Напрямок (HIGH/LOW) |
| Y_ENA | 8 | Вихід | Enable (HIGH = увімкнено) |
| Y_MIN | 3 | Вхід | Кінцевик MIN позиції |

### E-STOP кнопка

| Сигнал | GPIO | Active | Опис |
|--------|------|--------|------|
| ESTOP | 13 | HIGH | Апаратна аварійна кнопка |

### Логіка кінцевиків

```
Тип: NPN датчики (Active LOW)
Підтягування: Pull-up до 3.3V
Спрацювання: GPIO = 0 (LOW)
Вільний: GPIO = 1 (HIGH)
Дебаунсинг: 3 послідовних зчитування
```

---

## Параметри крокових моторів

### Конфігурація драйверів

```python
STEPS_PER_MM_X = 40.0      # Кроків на мм по X
STEPS_PER_MM_Y = 40.0      # Кроків на мм по Y
MAX_STEP_HZ = 30000        # Максимальна частота кроків (Гц)
PULSE_US = 10              # Тривалість імпульсу STEP (мкс)
```

### Швидкісні параметри

```python
MAX_FEED_MM_S = 600.0      # Максимальна швидкість (мм/с)
ACCEL_MM_S2 = 3500.0       # Прискорення (мм/с²)
START_SPEED_MM_S = 15.0    # Початкова швидкість рампи (мм/с)
```

### Робоча область

```
X: 0 - 220 мм
Y: 0 - 500 мм
Роздільна здатність: 0.025 мм (1/40 мм на крок)
```

---

## Serial комунікація

### Параметри з'єднання

| Параметр | Значення |
|----------|----------|
| Порт | /dev/ttyAMA0 |
| Швидкість | 115200 baud |
| Біти даних | 8 |
| Парність | Немає |
| Стоп-біти | 1 |
| Керування потоком | Немає |

### Протокол

```
Формат команди: COMMAND [ARGS]\n
Формат відповіді: ok [DATA]\n або err [MESSAGE]\n

Приклад:
  → G X100 Y200 F10000\n
  ← ok\n
```

---

## Підключення реле

### Схема підключення реле до контролера шуруповерта

```
                    ┌─────────────────────┐
                    │  Контролер          │
                    │  шуруповерта        │
                    ├─────────────────────┤
R05 (GPIO 19) ──────┤ DI4 (Free Run)      │
R06 (GPIO 20) ──────┤ DI1 (Torque Mode)   │
R07 (GPIO 21) ──────┤ DI5 (Task Bit 0)    │
R08 (GPIO 26) ──────┤ DI6 (Task Bit 1)    │
                    │                     │
DO2 ────────────────┤ DO2 (Torque OK)     │──── GPIO 25
                    └─────────────────────┘
```

### Вибір задачі (Task)

| Task | R07 | R08 | Бітова маска |
|------|-----|-----|--------------|
| 0 | OFF | OFF | 00 |
| 1 | ON (700мс) | OFF | 01 |
| 2 | OFF | ON (700мс) | 10 |
| 3 | ON | ON | 11 |

---

## Підключення пневматики

### Схема циліндра

```
                    ┌─────────────────────┐
R04 (GPIO 16) ──────┤ Електромагнітний    │
                    │ клапан              │
                    └─────────┬───────────┘
                              │
                              ▼
                    ┌─────────────────────┐
                    │   Пневмоциліндр     │
                    ├─────────────────────┤
                    │ ↑ GER_C2_UP (GPIO22)│
                    │ ↓ GER_C2_DOWN(GPIO23│
                    └─────────────────────┘

R04 ON  = Циліндр опускається
R04 OFF = Циліндр піднімається
```

---

## Підключення подавача гвинтів

```
                    ┌─────────────────────┐
R01 (GPIO 5) ───────┤ Соленоїд подавача   │
                    └─────────┬───────────┘
                              │
                              ▼
                    ┌─────────────────────┐
                    │   Трубка подачі     │
                    │   ┌───────────┐     │
                    │   │ Гвинт ●   │     │
                    │   └───────────┘     │
                    │        ↓            │
                    │  ind_scrw (GPIO 12) │ ← Індуктивний датчик
                    └─────────────────────┘

R01 імпульс 200мс = Подача одного гвинта
ind_scrw ACTIVE = Гвинт пройшов датчик
```

---

## Підключення світлової завіси

```
┌─────────────┐                    ┌─────────────┐
│ Передавач   │ ═══════════════════│ Приймач     │
│ (Світло)    │    Робоча зона     │             │
└─────────────┘                    └──────┬──────┘
                                          │
                                          ▼
                                   area_sensor
                                   (GPIO 17)

Промінь цілий (зона вільна): GPIO = HIGH (INACTIVE)
Промінь перерваний (зона зайнята): GPIO = LOW (ACTIVE)
```

---

## Підключення аварійної кнопки

### На Master Pi

```
┌──────────────────┐
│ E-STOP Mushroom  │
│    Button        │
│  (Нормально      │
│   замкнена)      │
└────────┬─────────┘
         │
         ▼
    GPIO 27 (emergency_stop)

Кнопка відпущена: GPIO = LOW (INACTIVE)
Кнопка натиснута: GPIO = HIGH (ACTIVE)
```

### На Slave Pi (XY стіл)

```
┌──────────────────┐
│ E-STOP Mushroom  │
│    Button        │
│  (Нормально      │
│   відкрита)      │
└────────┬─────────┘
         │
         ▼
    GPIO 13 (ESTOP_GPIO)
    Pull-up до 3.3V

Кнопка відпущена: GPIO = LOW (INACTIVE)
Кнопка натиснута: GPIO = HIGH (ACTIVE)
```

---

## Ієрархія увімкнення моторів

```
Рівень 1: Живлення драйвера
r09_pwr_x OFF → Драйвер X під напругою
r09_pwr_x ON  → Драйвер X без напруги

Рівень 2: Enable сигнал
X_ENA GPIO=1 → Мотор X увімкнено
X_ENA GPIO=0 → Мотор X вимкнено

Рівень 3: Гальмо
r02_brake_x ON  → Гальмо X розблоковано
r02_brake_x OFF → Гальмо X заблоковано
```

---

## Таймінги операцій

### Тривалості імпульсів

| Операція | Реле | Тривалість |
|----------|------|------------|
| Подача гвинта | R01 | 200мс |
| Вільне обертання (стоп) | R05 | 200мс |
| Вибір задачі | R07/R08 | 700мс |
| Скидання E-STOP | R05 | 300мс |

### Таймаути операцій

| Операція | Таймаут | Дія при перевищенні |
|----------|---------|---------------------|
| Опускання циліндра | 3.0с | ERROR |
| Підняття циліндра | 3.0с | ERROR |
| Досягнення моменту | 2.0с | TORQUE_ERROR |
| Хомінг однієї осі | 60с | HOME_ERROR |
| XY переміщення | 30с | MOVE_ERROR |

---

## Вимоги до живлення

### Raspberry Pi 5

| Параметр | Значення |
|----------|----------|
| Напруга | 5V DC |
| Струм | мін. 3A (рекомендовано 5A) |
| Роз'єм | USB-C |

### Крокові мотори

| Параметр | Значення |
|----------|----------|
| Напруга | 24V DC (типово) |
| Струм | 2-3A на фазу |

### Реле модуль

| Параметр | Значення |
|----------|----------|
| Логічна напруга | 3.3V |
| Комутована напруга | до 250V AC |
| Комутований струм | до 10A |

---

## Діагностика

### Перевірка датчиків

```bash
# На Master Pi
curl http://localhost:5000/api/sensors

# Очікувана відповідь:
{
  "alarm_x": "INACTIVE",
  "alarm_y": "INACTIVE",
  "area_sensor": "INACTIVE",
  "ped_start": "INACTIVE",
  "ger_c2_up": "ACTIVE",
  "ger_c2_down": "INACTIVE",
  "ind_scrw": "INACTIVE",
  "do2_ok": "INACTIVE",
  "emergency_stop": "INACTIVE"
}
```

### Перевірка реле

```bash
# Увімкнути реле
curl -X POST http://localhost:5000/api/relays/r01_pit -d '{"state":"on"}'

# Імпульс
curl -X POST http://localhost:5000/api/relays/r01_pit -d '{"state":"pulse","duration":200}'
```

### Перевірка XY столу

```bash
# На Slave Pi
python3 xy_cli.py

# Команди:
PING      # → PONG
M114      # → STATUS X:0.000 Y:0.000 ...
M119      # → X_MIN:open Y_MIN:open
```

---

## Типові проблеми

### Мотори не рухаються

1. Перевірити живлення драйверів (r09_pwr_x, r10_pwr_y OFF)
2. Перевірити Enable сигнали (M17)
3. Перевірити гальма (r02_brake_x, r03_brake_y ON)
4. Перевірити аларми драйверів (alarm_x, alarm_y)

### Хомінг не працює

1. Перевірити кінцевики (M119)
2. Перевірити напрямок руху
3. Перевірити таймаут хомінгу

### Момент не досягається

1. Перевірити сигнал DO2_OK
2. Перевірити режим моменту (R06)
3. Перевірити вибір задачі (R07, R08)
4. Перевірити налаштування контролера шуруповерта
