# Сценарії використання (User Flow)

## Ролі користувачів

| Роль | Опис | Доступ |
|------|------|--------|
| **Admin** | Адміністратор системи | Всі вкладки, керування користувачами |
| **Operator** | Оператор виробництва | Статус, Керування, XY Стіл, Налаштування |
| **Viewer** | Спостерігач | Тільки Статус |

---

## 1. Щоденний робочий процес оператора

### 1.1 Запуск зміни

```
Оператор приходить на робоче місце
    │
    ▼
Перевірка готовності машини:
    ├─ Живлення обох Pi увімкнено
    ├─ E-STOP кнопка відпущена
    ├─ Пневматика ввімкнена (тиск повітря)
    └─ Магазин гвинтів заповнений
    │
    ▼
Відкриття інтерфейсу:
    ├─ Web UI: http://<master-pi-ip>:5000
    └─ Desktop UI: автоматично запускається на сенсорному екрані
    │
    ▼
Вхід в систему:
    ├─ Ввести логін і пароль
    └─ Система перевіряє роль та доступ
    │
    ▼
Перевірка вкладки "Статус":
    ├─ XY стіл підключений (зелена індикація)
    ├─ Датчики в нормі (area_sensor, emergency_stop — INACTIVE)
    ├─ Циліндр у верхній позиції (ger_c2_up — ACTIVE)
    └─ Аларми відсутні (alarm_x, alarm_y — INACTIVE)
```

### 1.2 Робота з деталлю (основний цикл)

```
┌─────────────────────────────────────────────────────────────┐
│  КРОК 1: Вибір девайсу                                       │
│                                                               │
│  Оператор переходить на вкладку "Керування"                  │
│  └─ Обирає девайс зі списку (наприклад, MCO_BACK_M3x10)    │
│     ├─ Бачить: назва, кількість гвинтів, розмір, момент     │
│     └─ Система запам'ятовує обраний девайс                   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  КРОК 2: Ініціалізація                                       │
│                                                               │
│  Оператор натискає "ІНІЦІАЛІЗАЦІЯ"                           │
│  Система виконує автоматично:                                │
│     1. Перевірка алармів драйверів       (2%)                │
│     2. Перевірка E-STOP                  (5%)                │
│     3. Тест підключення XY столу         (10%)               │
│     4. Скидання E-STOP (M999)            (11%)               │
│     5. Увімкнення моторів (M17)          (12%)               │
│     6. Розблокування гальм               (15%)               │
│     7. Хомінг XY столу (G28)            (25%)               │
│     8. Тест датчиків циліндра            (35%)               │
│     9. Опускання циліндра (тест)         (50%)               │
│    10. Підняття циліндра                 (60%)               │
│    11. Вибір задачі шуруповерта          (75%)               │
│    12. Рух до позиції оператора          (85%)               │
│    13. Готово                            (100%)              │
│                                                               │
│  Прогрес-бар показує стан ініціалізації                      │
│  Після завершення — система в стані READY                    │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  КРОК 3: Встановлення деталі                                 │
│                                                               │
│  Оператор кладе деталь на XY стіл                           │
│  └─ Фіксує деталь у пристосуванні (фікстурі)               │
│  └─ Перевіряє правильність орієнтації                       │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  КРОК 4: Запуск циклу                                        │
│                                                               │
│  Оператор натискає "СТАРТ" (або педаль старту)              │
│  Система автоматично для кожного гвинта:                    │
│                                                               │
│     Для кожного кроку в програмі:                            │
│     │                                                         │
│     ├── type = FREE:                                          │
│     │   └─ Швидке переміщення до позиції                    │
│     │                                                         │
│     └── type = WORK:                                          │
│         ├─ Рух до позиції закручування                      │
│         ├─ Подача гвинта (R01, до 3 спроб)                  │
│         ├─ Увімкнення моменту (R06 ON)                      │
│         ├─ Опускання циліндра (R04 ON)                      │
│         ├─ Закручування до моменту (do2_ok)                 │
│         ├─ Підняття циліндра (R04 OFF)                      │
│         └─ Free run імпульс (R05)                           │
│                                                               │
│  Індикація на екрані:                                        │
│  ├─ Прогрес: "Закручено 2/4 гвинтів"                       │
│  ├─ Поточна позиція: X: 80.0  Y: 100.0                      │
│  └─ Стан: RUNNING                                            │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  КРОК 5: Завершення                                          │
│                                                               │
│  Після закручування всіх гвинтів:                           │
│  ├─ XY стіл повертається до позиції оператора               │
│  ├─ Стан: COMPLETED                                          │
│  ├─ Лічильник циклів збільшується                           │
│  └─ Оператор знімає готову деталь                           │
│                                                               │
│  Повторення: Оператор кладе нову деталь → "СТАРТ"          │
└─────────────────────────────────────────────────────────────┘
```

### 1.3 Завершення зміни

```
Оператор завершує роботу:
    ├─ Натискає "СТОП" (якщо цикл активний)
    ├─ XY стіл повертається до позиції оператора
    ├─ Знімає останню деталь
    └─ Вимикає систему або залишає в IDLE
```

---

## 2. Сценарії обробки помилок

### 2.1 Момент не досягнуто (TORQUE_NOT_REACHED)

```
Під час закручування:
    │
    ▼
do2_ok не став ACTIVE за 2 секунди
    │
    ▼
Система автоматично:
    ├─ Вимикає режим моменту (R06 OFF)
    ├─ Піднімає циліндр (R04 OFF)
    ├─ Імпульс free run (R05)
    ├─ Повертає стіл до позиції оператора
    └─ Стан: PAUSED
    │
    ▼
На екрані: "Момент не досягнуто. Перевірте гвинт."
    │
    ▼
Дії оператора:
    ├─ Перевірити гвинт (чи правильно подано, чи не перекошено)
    ├─ Видалити проблемний гвинт якщо потрібно
    └─ Натиснути "СТАРТ" для продовження
    │
    ▼
Система продовжує з того ж гвинта
```

### 2.2 Спрацювання світлової завіси (AREA_BLOCKED)

```
Під час роботи руки оператора перетинають зону:
    │
    ▼
area_sensor → ACTIVE
    │
    ▼
Система НЕГАЙНО:
    ├─ Зупиняє рух XY столу
    ├─ Піднімає циліндр (R04 OFF)
    ├─ Вимикає режим моменту (R06 OFF)
    ├─ Імпульс free run (R05, 300мс)
    ├─ Вимикає мотори XY (M18)
    └─ Стан: AREA_BLOCKED
    │
    ▼
Діалог на екрані:
    ┌──────────────────────────────────┐
    │    СВІТЛОВА ЗАВІСА!              │
    │                                  │
    │  Зона безпеки заблокована.       │
    │  Заберіть руки та натисніть      │
    │  кнопку.                         │
    │                                  │
    │  [    ЗОНА БЕЗПЕЧНА    ]         │
    └──────────────────────────────────┘
    │
    ▼
Дії оператора:
    ├─ Забрати руки із робочої зони
    └─ Натиснути "ЗОНА БЕЗПЕЧНА"
    │
    ▼
Потрібна повна переініціалізація:
    └─ Натиснути "ІНІЦІАЛІЗАЦІЯ" для перезапуску
```

### 2.3 Аварійна зупинка (E-STOP)

```
Оператор натискає червону грибоподібну кнопку E-STOP:
    │
    ▼
emergency_stop GPIO → ACTIVE (HIGH)
    │
    ▼
Система НЕГАЙНО:
    ├─ Вимикає всі мотори
    ├─ Піднімає циліндр
    ├─ Вимикає шуруповерт
    ├─ Інвалідує хомінг
    └─ Стан: ESTOP
    │
    ▼
Діалог на екрані:
    ┌──────────────────────────────────┐
    │    АВАРІЙНА ЗУПИНКА!             │
    │                                  │
    │  Відпустіть кнопку E-STOP та     │
    │  виконайте переініціалізацію.    │
    └──────────────────────────────────┘
    │
    ▼
Відновлення:
    1. Відпустити (провернути) кнопку E-STOP
    2. Натиснути "Скинути E-STOP" у інтерфейсі
    3. Натиснути "ІНІЦІАЛІЗАЦІЯ" для повного перезапуску
```

### 2.4 Аларм драйвера (DRIVER_ALARM)

```
alarm_x або alarm_y → ACTIVE
    │
    ▼
Під час ініціалізації:
    ├─ Система вимикає живлення драйвера (1 секунда)
    ├─ Вмикає живлення
    ├─ Очікує 500мс стабілізації
    ├─ Перезапускає ініціалізацію з початку
    └─ Максимум 3 спроби
    │
    ▼
Під час робочого циклу:
    ├─ Аварійна зупинка XY (3 спроби)
    ├─ Вимкнення R04, R06
    └─ Стан: ERROR
    │
    ▼
На екрані: "АВАРІЯ ДРАЙВЕРА! Вийміть деталь."
    │
    ▼
Дії оператора:
    ├─ Вийняти деталь
    ├─ Перевірити з'єднання моторів
    └─ Натиснути "ІНІЦІАЛІЗАЦІЯ" для перезапуску
```

### 2.5 Гвинт не подано (SCREW_NOT_DETECTED)

```
Під час подачі гвинта:
    │
    ▼
3 спроби подачі (R01 імпульс) без спрацювання ind_scrw
    │
    ▼
Стан: ERROR
На екрані: "Гвинт не виявлено після 3 спроб"
    │
    ▼
Дії оператора:
    ├─ Перевірити магазин гвинтів (заповнити)
    ├─ Перевірити трубку подачі (прочистити)
    └─ Натиснути "ІНІЦІАЛІЗАЦІЯ" для перезапуску
```

---

## 3. Сценарій адміністратора

### 3.1 Створення нового користувача

```
Адміністратор:
    │
    ▼
Перехід на вкладку "Адмін"
    │
    ▼
Натискання "Додати користувача"
    │
    ▼
Заповнення форми:
    ├─ Username: operator1
    ├─ Password: ********
    ├─ Role: User
    └─ Дозволені вкладки:
       ├─ [✓] Status (завжди)
       ├─ [✓] Control
       ├─ [✓] XY Table
       └─ [ ] Settings, Admin, Logs
    │
    ▼
Натискання "Зберегти"
    │
    ▼
Новий користувач може увійти з обмеженим доступом
```

### 3.2 Створення нового девайсу (програми закручування)

```
Адміністратор або оператор:
    │
    ▼
Перехід на вкладку "Налаштування"
    │
    ▼
Натискання [+] "Новий девайс"
    │
    ▼
Заповнення параметрів:
    ├─ Назва (4 символи):    NEWP
    ├─ Що крутим:            Нова панель
    ├─ Кількість гвинтів:   6
    ├─ Розмір гвинта:        M3x10
    ├─ Таска:                0
    ├─ Момент:               0.80 Nm
    ├─ Робоча позиція X:     50.0 мм
    ├─ Робоча позиція Y:     100.0 мм
    └─ Швидкість:            5000 мм/хв
    │
    ▼
Додавання координат гвинтів:
    ├─ Використання міні XY керування (ліва панель):
    │   ├─ Джогінг для знаходження позиції
    │   └─ Точне позиціонування через ввід координат
    ├─ Для кожної позиції:
    │   ├─ Переміщення столу до потрібної точки
    │   ├─ Додавання рядка: X, Y, Тип (FREE/WORK), Feed
    │   └─ Типовий порядок: FREE → WORK → WORK → ...
    │
    ▼
Натискання "Зберегти параметри"
    │
    ▼
Новий девайс доступний для вибору в "Керуванні"
```

### 3.3 Редагування координат існуючого девайсу

```
Адміністратор/оператор:
    │
    ▼
Вкладка "Налаштування" → Вибрати девайс зі списку
    │
    ▼
Таблиця координат з'являється справа:
    ┌───┬────────┬────────┬──────┬───────┬─────────┐
    │ # │ X (мм) │ Y (мм) │ Тип  │ Feed  │ Дії     │
    ├───┼────────┼────────┼──────┼───────┼─────────┤
    │ 1 │ 10.5   │ 20.0   │ FREE │ F5000 │ ↑↓⊕−   │
    │ 2 │ 50.0   │ 100.0  │ WORK │ F3000 │ ↑↓⊕−   │
    └───┴────────┴────────┴──────┴───────┴─────────┘
    │
    ▼
Доступні дії:
    ├─ ↑ / ↓ — змінити порядок кроку
    ├─ ⊕ — додати крок після поточного
    ├─ − — видалити крок
    ├─ Клік на X/Y — редагувати координату
    └─ Клік на тип — переключити FREE/WORK
    │
    ▼
Натискання "Зберегти параметри"
```

---

## 4. Ручне керування XY столом

### 4.1 Джогінг (ручне переміщення)

```
Оператор на вкладці "XY Стіл":
    │
    ▼
Підключення до XY столу:
    └─ Натиснути "Connect" (якщо не підключений)
    │
    ▼
Хомінг (якщо ще не виконаний):
    └─ Натиснути "Home" [Обидва] або [X] / [Y]
    │
    ▼
Вибір кроку переміщення:
    └─ [0.1] [0.5] [1] [5] [10] [50] [100] мм
    │
    ▼
Вибір швидкості:
    └─ [1000] [3000] [5000] [10000] мм/хв
    │
    ▼
Джогінг кнопками:
         [ Y- ]
   [ X- ] [Home] [ X+ ]
         [ Y+ ]
    │
    ▼
Або точне переміщення:
    ├─ Ввести X, Y координати
    ├─ Вибрати тип: Фізичні або Робочі
    └─ Натиснути "GO"
```

### 4.2 Встановлення робочого офсету

```
Оператор на вкладці "XY Стіл":
    │
    ▼
Перемістити стіл до потрібної нульової точки
(використовуючи джогінг)
    │
    ▼
В секції "Робочий офсет":
    ├─ Натиснути "Поточну → нуль" — поточна позиція стає нулем
    └─ Або ввести значення вручну та натиснути "Зберегти офсет"
    │
    ▼
Всі робочі координати тепер відносно цієї точки
```

---

## 5. Сценарії зі сканером штрих-кодів

### 5.1 Ідентифікація деталі за штрих-кодом

```
Оператор сканує штрих-код на деталі або фікстурі:
    │
    ▼
USB сканер зчитує код
(наприклад: "3SD-ST-E_MCO-P_BK-S_310")
    │
    ▼
Система шукає відповідність у fixtures.yaml:
    ├─ Знайдено → автоматично обирає відповідний девайс
    │   ├─ Переміщує стіл до позиції сканування (scan_x, scan_y)
    │   └─ Готова до ініціалізації
    │
    └─ Не знайдено → повідомлення "Невідомий код"
```

---

## 6. Сценарій з USB-камерою

### 6.1 Live preview та відеозапис

```
Адміністратор/оператор через Web UI:
    │
    ▼
Камера автоматично виявляється при запуску системи
    │
    ▼
Live preview:
    └─ MJPEG стрім доступний у вкладці "Статус" або окремому вікні
    │
    ▼
Відеозапис:
    ├─ Запис починається автоматично при старті циклу
    ├─ Зберігається на USB-накопичувач
    ├─ Ротація: старі записи видаляються при досягненні 35 ГБ
    └─ Запис зупиняється при завершенні/помилці циклу
```

---

## 7. Перший запуск системи (First Time Setup)

```
1. Фізичне підключення:
   ├─ Підключити Master Pi до мережі
   ├─ Підключити Slave Pi через UART (TX-RX, RX-TX, GND)
   ├─ Підключити GPIO кабелі (реле, датчики)
   ├─ Підключити пневматику
   └─ Підключити живлення
   │
   ▼
2. Встановлення ПЗ (див. INSTALLATION.md):
   ├─ Клонувати репозиторій на обидва Pi
   ├─ Встановити залежності
   ├─ Налаштувати UART
   └─ Встановити systemd сервіси
   │
   ▼
3. Налаштування конфігурації:
   ├─ config/settings.yaml — параметри руху, таймінги
   ├─ config/gpio_pins.yaml — призначення GPIO
   ├─ config/auth.yaml — створити адміністратора
   └─ config/devices.yaml — додати програми девайсів
   │
   ▼
4. Перевірка підключень:
   ├─ На Slave Pi: python3 xy_cli.py → PING → PONG
   ├─ На Master Pi: curl http://localhost:5000/api/health
   ├─ Перевірка датчиків: curl http://localhost:5000/api/sensors
   └─ Перевірка реле: через Web UI вкладка "Керування"
   │
   ▼
5. Калібрування:
   ├─ Виконати хомінг (G28)
   ├─ Встановити робочий офсет
   ├─ Створити перший девайс
   └─ Виконати тестовий цикл без деталі
   │
   ▼
6. Робоча система готова
```

---

## 8. Діаграма переходів станів (з точки зору оператора)

```
                    ┌─────────────────┐
                    │                 │
                    │    ВИМКНЕНО     │
                    │   (Power Off)   │
                    │                 │
                    └───────┬─────────┘
                            │ Увімкнення
                            ▼
                    ┌─────────────────┐
                    │                 │
              ┌─────│   ОЧІКУВАННЯ    │◄───────────────────────┐
              │     │    (IDLE)       │                        │
              │     │                 │                        │
              │     └───────┬─────────┘                        │
              │             │ Вибір девайсу                     │
              │             │ + "ІНІЦІАЛІЗАЦІЯ"                 │
              │             ▼                                   │
              │     ┌─────────────────┐                        │
              │     │                 │                        │
              │     │ ІНІЦІАЛІЗАЦІЯ   │────── Помилка ─────────┤
              │     │  (HOMING)       │                        │
              │     │                 │                        │
              │     └───────┬─────────┘                        │
              │             │ Успіх                             │
              │             ▼                                   │
              │     ┌─────────────────┐                        │
              │     │                 │                        │
    "СТОП"    │     │    ГОТОВИЙ      │                        │
    ──────────┤     │    (READY)      │◄──────── "СТАРТ"       │
              │     │                 │         (з PAUSED)     │
              │     └───────┬─────────┘                        │
              │             │ "СТАРТ"                           │
              │             │ або Педаль                        │
              │             ▼                                   │
              │     ┌─────────────────┐                        │
              │     │                 │                        │
              │     │    РОБОТА       │                        │
              ├─────│   (RUNNING)     │─── Помилка моменту ──►│
              │     │                 │         │              │
              │     └───────┬─────────┘         ▼              │
              │             │             ┌───────────┐        │
              │             │ Всі гвинти  │  ПАУЗА    │        │
              │             │ закручені   │ (PAUSED)  │────────┘
              │             │             └───────────┘
              │             ▼                   ▲
              │     ┌─────────────────┐        │
              │     │                 │   Переініціалізація
              │     │   ЗАВЕРШЕНО     │        │
              │     │  (COMPLETED)    │        │
              │     │                 │        │
              │     └───────┬─────────┘        │
              │             │ Нова деталь       │
              │             │ + "СТАРТ"         │
              │             └──────────►READY   │
              │                                 │
              │     ┌─────────────────┐         │
              │     │                 │         │
              └────►│   ПОМИЛКА       │─────────┘
                    │   (ERROR)       │
                    │                 │
                    └─────────────────┘

         E-STOP може статися з будь-якого стану!
                    ┌─────────────────┐
                    │                 │
                    │   E-STOP        │───► Потрібна
                    │                 │     повна
                    └─────────────────┘     переініціалізація
```

---

## 9. Web UI vs Desktop UI — порівняння

| Аспект | Web UI | Desktop UI |
|--------|--------|------------|
| Доступ | Браузер з будь-якого пристрою | Сенсорний екран на Master Pi |
| Вкладки | 6 вкладок (Статус, Керування, XY, Налаштування, Адмін, Логи) | 2 режими (START, WORK) |
| Призначення | Повне керування та моніторинг | Оператор на виробництві |
| Ручне керування реле | Так | Ні |
| Детальний джогінг | Так (вкладка XY) | Ні |
| Редактор девайсів | Так (вкладка Налаштування) | Ні |
| Керування користувачами | Так (вкладка Адмін) | Ні |
| Перегляд логів | Так (вкладка Логи) | Ні |
| Робочий цикл | Вкладка Керування | Режим WORK (оптимізований) |
| Синхронізація | Через REST API (polling) | Через REST API (polling) |

---

## 10. Типові задачі та де їх виконувати

| Задача | Де виконувати | Вкладка/Режим |
|--------|---------------|---------------|
| Запустити цикл закручування | Web UI або Desktop UI | Керування / WORK |
| Перевірити стан датчиків | Web UI | Статус |
| Налаштувати новий девайс | Web UI | Налаштування |
| Вручну перемістити стіл | Web UI | XY Стіл |
| Додати користувача | Web UI | Адмін |
| Переглянути логи помилок | Web UI | Логи |
| Тестувати реле вручну | Web UI | Керування |
| Ідентифікувати деталь сканером | Автоматично | Будь-який режим |
| Переглянути відео з камери | Web UI | Статус |
| Оновити код на сервері | SSH | Див. DEPLOY_PULL_GUIDE.md |
