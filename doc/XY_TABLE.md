# Система керування XY столом

## Огляд

XY координатний стіл керується окремим Raspberry Pi 5 (Slave Pi) через serial протокол. Основний контролер (`xy_cli.py`) підтримує G-code сумісні команди та забезпечує пряме GPIO керування кроковими моторами.

---

## Параметри руху

### Механічні параметри

| Параметр | Значення | Опис |
|----------|----------|------|
| STEPS_PER_MM_X | 40.0 | Кроків на мм по осі X |
| STEPS_PER_MM_Y | 40.0 | Кроків на мм по осі Y |
| X_MIN_MM | 0.0 | Мінімум X |
| X_MAX_MM | 220.0 | Максимум X |
| Y_MIN_MM | 0.0 | Мінімум Y |
| Y_MAX_MM | 500.0 | Максимум Y |

### Швидкісні параметри

| Параметр | Значення | Опис |
|----------|----------|------|
| MAX_FEED_MM_S | 600.0 | Максимальна швидкість (мм/с) |
| MAX_STEP_HZ | 30000 | Максимальна частота кроків |
| ACCEL_MM_S2 | 3500.0 | Прискорення (мм/с²) |
| START_SPEED_MM_S | 15.0 | Початкова швидкість рампи |

### Параметри хомінгу

| Параметр | Значення | Опис |
|----------|----------|------|
| BACKOFF_MM | 5.0 | Відступ від кінцевика |
| SLOW_MM_S | 2.0 | Повільна швидкість підходу |
| HOMING_TIMEOUT_S | 60.0 | Таймаут хомінгу |

---

## Підтримувані команди

### Діагностичні команди

| Команда | Відповідь | Опис |
|---------|-----------|------|
| `PING` | `PONG` | Тест з'єднання |
| `GETIP` | `IP 192.168.x.x` | IP адреса Slave Pi |
| `M114` | `STATUS X:... Y:... ok` | Повний статус |
| `M119` | `X_MIN:open Y_MIN:open ok` | Стан кінцевиків |

### Керування моторами

| Команда | Відповідь | Опис |
|---------|-----------|------|
| `M17` | `ok` | Увімкнути мотори |
| `M18` | `ok` | Вимкнути мотори |

**Важливо:** M17 заблоковано якщо E-STOP активний. Повертає `err ESTOP`.

### Аварійна зупинка

| Команда | Відповідь | Опис |
|---------|-----------|------|
| `M112` | `ok ESTOP` | Аварійна зупинка |
| `M999` | `ok CLEAR` | Скинути E-STOP |
| `CANCEL` | - | Зупинити рух (тільки serial) |

### Хомінг

| Команда | Відповідь | Опис |
|---------|-----------|------|
| `G28` | `ok IN_HOME_POS` | Хомінг обох осей |
| `G28 X` | `ok IN_X_HOME_POS` | Хомінг тільки X |
| `G28 Y` | `ok IN_Y_HOME_POS` | Хомінг тільки Y |
| `HOME` | Аналог G28 | Альтернативний синтаксис |
| `CAL` | `ok` | Хомінг + рух до (0,0) |
| `ZERO` | `ok IN_HOME_POS` | Повний хомінг |

### Лінійний рух

| Команда | Формат | Опис |
|---------|--------|------|
| `G0` | `G0 X<mm> Y<mm> F<mm/min>` | Лінійний рух |
| `G1` | `G1 X<mm> Y<mm> F<mm/min>` | Ідентично G0 |
| `G` | `G X<mm> Y<mm> F<mm/min>` | Рух з перевіркою лімітів |
| `GF` | `GF X<mm> Y<mm> F<mm/min>` | Швидкий рух |

**Приклад:**
```
G X100 Y200 F10000
→ ok

G X250 Y100 F10000
→ ok LIMIT_X_MAX:220.0
```

### Джогінг (відносний рух)

| Команда | Формат | Опис |
|---------|--------|------|
| `DX` | `DX ±<mm> F<mm/min>` | Джог по X |
| `DY` | `DY ±<mm> F<mm/min>` | Джог по Y |
| `JX` | `JX ±<mm> F<mm/min>` | Legacy джог X |
| `JY` | `JY ±<mm> F<mm/min>` | Legacy джог Y |

**Приклад:**
```
DX +10 F600
→ ok

DY -5 F600
→ ok
```

### Кругова інтерполяція (дуги)

**Offset нотація (I/J):**
```
G2 X<end> Y<end> I<offset_x> J<offset_y> P<passes> F<mm/min>  # За годинниковою
G3 X<end> Y<end> I<offset_x> J<offset_y> P<passes> F<mm/min>  # Проти годинникової
```

**Radius нотація (R):**
```
G2 X<end> Y<end> R<radius> F<mm/min>
G3 X<end> Y<end> R<radius> F<mm/min>
```

### Робоча позиція

| Команда | Формат | Опис |
|---------|--------|------|
| `WORK` | `WORK` | Рух до збереженої позиції |
| `WORK X Y F` | `WORK X10 Y350 F60000` | Рух до вказаної позиції |
| `SET WORK` | `SET WORK X<mm> Y<mm> F<mm/min>` | Зберегти позицію |

### Налаштування

| Команда | Формат | Опис |
|---------|--------|------|
| `SET LIM` | `SET LIM X<mm> Y<mm>` | Встановити ліміти |
| `SET STEPS` | `SET STEPS X<val> Y<val>` | Встановити кроки/мм |
| `SET X0` | `SET X0` | Обнулити X позицію |
| `SET Y0` | `SET Y0` | Обнулити Y позицію |
| `SET XY0` | `SET XY0` | Обнулити обидві |
| `F<mm/min>` | `F10000` | Встановити швидкість |

---

## Процедура хомінгу

### Алгоритм (3 фази)

**Фаза 1: Швидкий відступ** (якщо на кінцевику)
```
Якщо кінцевик спрацював:
  1. Рух від кінцевика на BACKOFF_MM (5мм)
  2. Швидкість: 300 мм/с
```

**Фаза 2: Швидкий пошук**
```
1. Рух до кінцевика
2. Швидкість: 300 мм/с
3. Перевірка E-STOP на кожному кроці
4. Зупинка при спрацюванні кінцевика
```

**Фаза 3: Повільний дотик**
```
1. Відступ на BACKOFF_MM (5мм)
2. Повільний рух до кінцевика
3. Швидкість: 2 мм/с
4. Встановлення позиції = 0
5. Позначення осі як "захомлена"
```

### Послідовність хомінгу

```
G28 виконує:
  1. Хомінг Y (спочатку)
  2. Хомінг X (потім)
  → ok IN_HOME_POS
```

**Чому Y спочатку?** Для передбачуваної початкової позиції перед рухом X.

---

## Профіль руху (трапеція)

### Фази руху

```
Швидкість
    ▲
    │      ┌────────────────┐
    │     /                  \
    │    /                    \
    │   /                      \
    │  /                        \
    │ /                          \
    └─────────────────────────────► Час
      Розгін    Const    Гальмування
```

### Формули

**Розгін:**
```
v² = v0² + 2·a·s
v = √(v0² + 2·acceleration·distance)
```

**Гальмування:**
```
Дзеркальне до розгону
```

**Трикутний профіль** (короткі переміщення):
```
Якщо (dist_accel + dist_decel) > total_distance:
  - Розгін: перша половина шляху
  - Гальмування: друга половина
  - Без фази const
```

---

## Координатна система

### Фізичні координати

```
Початок: MIN кінцевики обох осей
Фізичний X=0: X на MIN кінцевику
Фізичний Y=0: Y на MIN кінцевику

Позитивний напрямок:
  X → праворуч (від X_MIN)
  Y → назад (від Y_MIN)
```

### Робочі координати

```
Зміщення від машинного нуля
Встановлюються через:
  - SET WORK X<mm> Y<mm> F<mm/min>
  - API /api/offsets
```

### Відстеження позиції

```python
cur_x_mm = 0.0    # Поточна X позиція (float, мм)
cur_y_mm = 0.0    # Поточна Y позиція (float, мм)
x_homed = False   # Чи захомлена X
y_homed = False   # Чи захомлена Y
```

---

## Обробка E-STOP

### Апаратний E-STOP

**GPIO моніторинг:**
```python
ESTOP_GPIO = 13           # GPIO для кнопки
ESTOP_ACTIVE_LOW = False  # HIGH = натиснуто
```

**Перевірка на кожному кроці:**
```python
for step in range(steps):
    if estop_gpio_active():
        trigger_hardware_estop()
        return False
```

### Дії при E-STOP

```python
def trigger_hardware_estop():
    estop = True
    cancel_requested = True
    x_homed = False      # Інвалідація хомінгу!
    y_homed = False
    enable_all(False)    # Вимкнути мотори
```

### Відновлення після E-STOP

```
1. Відпустити кнопку E-STOP
2. Відправити M999 (Clear E-STOP)
3. Відправити M17 (Enable motors)
4. Виконати G28 (Rehoming) - ОБОВ'ЯЗКОВО!
```

**Важливо:** Мотори залишаються ВИМКНЕНИМИ після скидання E-STOP для безпеки. Потрібна явна команда M17.

---

## Serial режим

### Архітектура потоків

```
┌─────────────────────────────────────────────────┐
│              xy_cli.py --serial                  │
├─────────────────────────────────────────────────┤
│                                                  │
│  ┌──────────────────┐    ┌───────────────────┐  │
│  │ serial_reader    │    │ main loop         │  │
│  │ (фоновий потік)  │    │ (головний потік)  │  │
│  │                  │    │                   │  │
│  │ - Читання serial │    │ - Обробка команд  │  │
│  │ - Моніторинг     │    │ - Відправка       │  │
│  │   E-STOP         │───→│   відповідей      │  │
│  │ - M112/CANCEL    │    │ - handle_command()│  │
│  │   (пріоритет)    │    │                   │  │
│  └──────────────────┘    └───────────────────┘  │
│                                                  │
└─────────────────────────────────────────────────┘
```

### Пріоритетні команди

Обробляються безпосередньо в reader thread:
- `M112` - E-STOP
- `M999` - Clear E-STOP
- `CANCEL` - Скасувати рух

### Черга команд

Інші команди йдуть через чергу:
```python
cmd_queue.put(line)  # reader додає
line = cmd_queue.get(timeout=0.01)  # main обробляє
```

---

## Двоосьовий координований рух

### Bresenham алгоритм

```python
# Розрахунок кроків
sx = int(round(abs(dx) * STEPS_PER_MM_X))
sy = int(round(abs(dy) * STEPS_PER_MM_Y))

# Домінуюча вісь як таймлайн
total_steps = max(sx, sy)
ratio_x = sx / total_steps
ratio_y = sy / total_steps

# Акумулятори для рівномірного розподілу
accum_x = 0.0
accum_y = 0.0

for step in range(total_steps):
    accum_x += ratio_x
    accum_y += ratio_y

    if accum_x >= 1.0:
        accum_x -= 1.0
        # Крок X

    if accum_y >= 1.0:
        accum_y -= 1.0
        # Крок Y
```

### Синхронізоване прискорення

Прискорення застосовується на основі **пройденої відстані**, не окремих кроків:
```python
dist_traveled = √(done_x² + done_y²) / STEPS_PER_MM
```

---

## API інтеграція

### Клас XYTableController

**Файл:** `screwdrive/core/xy_table.py`

**Стани:**
```
DISCONNECTED → CONNECTING → READY → MOVING/HOMING → ERROR/ESTOP
```

**Ключові методи:**
```python
connect()                   # Встановити з'єднання
disconnect()                # Закрити
home(axis=None)             # Хомінг (None = обидві)
move_to(x, y, feed)         # Абсолютний рух
move_relative(dx, dy, feed) # Відносний рух
estop()                     # E-STOP
clear_estop()               # Скинути E-STOP
enable_motors()             # M17
disable_motors()            # M18
ping()                      # Тест з'єднання
get_status()                # M114
get_position()              # Поточні координати
```

### Health моніторинг

```python
# Періодичний пінг кожні 2 секунди
response = self._send_command("PING", timeout=3.0)
if response == "PONG":
    self._health.last_ping_ok = True
```

### Авто-реконект

При 3 послідовних помилках:
1. Закриття serial порту
2. SSH restart сервісу на Slave Pi
3. Повторне відкриття порту

---

## Діагностика

### Перевірка з'єднання

```bash
# На Slave Pi
python3 xy_cli.py

> PING
PONG

> M114
STATUS X:0.000 Y:0.000 X_MIN:open Y_MIN:open X_HOMED:0 Y_HOMED:0 ESTOP:0 HW_ESTOP:open
ok

> M119
X_MIN:open Y_MIN:open
ok
```

### Тестування руху

```bash
> M17          # Enable motors
ok

> G28          # Homing
X axis homed successfully
Y axis homed successfully
ok IN_HOME_POS

> G X100 Y200 F10000
ok

> M114
STATUS X:100.000 Y:200.000 ...
ok
```

### Типові помилки

| Помилка | Причина | Рішення |
|---------|---------|---------|
| `err ESTOP` | E-STOP активний | M999, M17, G28 |
| `err NOT_HOMED` | Осі не захомлені | G28 |
| `err HOME_NOT_FOUND` | Таймаут хомінгу | Перевірити кінцевики |
| `err BAD_ARGS` | Неправильні параметри | Перевірити синтаксис |
