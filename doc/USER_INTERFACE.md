# Інтерфейси користувача

## Огляд

Система має два інтерфейси користувача:
- **Web UI** - браузерний інтерфейс (HTML/JS)
- **Desktop UI** - сенсорний інтерфейс (PyQt5)

Обидва інтерфейси синхронізують стан через REST API.

---

## Web UI

### Вкладки

| Вкладка | Опис | Доступ |
|---------|------|--------|
| Статус | Моніторинг в реальному часі | Всі |
| Керування | Керування циклом | Оператор+ |
| XY Стіл | Позиціонування | Оператор+ |
| Налаштування | Редактор девайсів | Оператор+ |
| Адмін | Керування користувачами | Адмін |
| Логи | Перегляд логів | Адмін |

### Вкладка "Статус"

**Картка стану циклу:**
- Поточний стан (IDLE, RUNNING, COMPLETED, ERROR)
- Обраний девайс
- Прогрес (закручено X / Y гвинтів)
- Лічильник циклів

**Картка стану XY столу:**
- Поточна позиція (X, Y)
- Стан руху

**Сітка датчиків (5 колонок):**
- Реальний час стану датчиків
- Колірна індикація (зелений/червоний)

**Сітка реле (5 колонок):**
- Стан всіх 10 реле
- ON/OFF індикація

### Вкладка "Керування"

**Секція керування циклом:**
```
┌─────────────────────────────────────┐
│ Девайс: [▼ Вибір девайсу      ]    │
├─────────────────────────────────────┤
│ [ІНІЦІАЛІЗАЦІЯ]                     │
│ [СТАРТ]  [СТОП]  [ПАУЗА]           │
├─────────────────────────────────────┤
│ [    АВАРІЯ (E-STOP)    ]          │
│ [Скинути E-STOP]                    │
└─────────────────────────────────────┘
```

**Ручне керування реле:**
- Сітка з кнопками ON/OFF для кожного реле
- Поле тривалості імпульсу (мс)
- Кнопка PULSE

### Вкладка "XY Стіл"

**Панель підключення:**
- Стан сервісу
- Затримка пінгу
- Стан кінцевиків
- Кнопки: Connect, Disconnect, Ping

**Дисплей позиції:**
```
Фізичні координати: X: 100.00  Y: 200.00
Робочі координати:  X: 50.00   Y: 150.00
Хомінг: X: ✓  Y: ✓
```

**Панель джогінгу:**
```
          [ Y- ]
    [ X- ] [Home] [ X+ ]
          [ Y+ ]

Крок: [0.1] [0.5] [1] [5] [10] [50] [100] мм
Швидкість: [1000] [3000] [5000] [10000] мм/хв
```

**Переміщення до позиції:**
```
Тип: (●) Фізичні  ( ) Робочі
X: [______] мм
Y: [______] мм
F: [______] мм/хв
[    GO    ]
```

**Робочий офсет:**
```
Offset X: [______]  Offset Y: [______]
[Зберегти офсет]  [Поточну → нуль]
```

**Швидкі дії:**
- Хомінг: [X] [Y] [Обидва]
- [До нуля]
- [Enable] [Disable] мотори
- Гальма: [X: ▓] [Y: ▓]

### Вкладка "Налаштування"

**Ліва колонка (33%):**
```
┌─────────────────────────┐
│ Список девайсів    [+]  │
├─────────────────────────┤
│ ▶ MCO_BACK_M3x10       │
│   PANEL_FRONT_M3x8     │
│   COVER_TOP_M3x6       │
└─────────────────────────┘

┌─────────────────────────┐
│ Міні XY керування       │
│ X: 100.00  Y: 200.00    │
│    [ Y- ]               │
│ [X-][  ][X+]            │
│    [ Y+ ]               │
│ [Home X][Home Y]        │
└─────────────────────────┘
```

**Права колонка (66%):**

**Таблиця координат:**
```
┌───┬────────┬────────┬──────┬───────┬─────────┐
│ # │ X (мм) │ Y (мм) │ Тип  │ Feed  │ Дії     │
├───┼────────┼────────┼──────┼───────┼─────────┤
│ 1 │ 10.5   │ 20.0   │ FREE │ F5000 │ ↑↓⊕−   │
│ 2 │ 50.0   │ 100.0  │ WORK │ F3000 │ ↑↓⊕−   │
│ 3 │ 80.0   │ 100.0  │ WORK │ F3000 │ ↑↓⊕−   │
└───┴────────┴────────┴──────┴───────┴─────────┘
[+ Додати рядок]
```

**Редактор девайсу:**
```
Назва (4 символи):  [BACK]
Що крутим:          [Задня панель        ]
Кількість гвинтів:  [▼ 4]
Розмір гвинта:      [▼ M3x10]
Таска:              [▼ 0]
Момент (Nm):        [0.80]
Робоча позиція X:   [50.0 ] мм
Робоча позиція Y:   [100.0] мм
Швидкість:          [5000 ] мм/хв

[Зберегти параметри]  [Скасувати]
[Видалити девайс]
```

### Вкладка "Адмін"

**Список користувачів:**
```
┌──────────┬───────┬────────────────┬─────────┐
│ Username │ Role  │ Дозволені таби │ Дії     │
├──────────┼───────┼────────────────┼─────────┤
│ admin    │ Admin │ Всі            │ [✎][🗑] │
│ operator │ User  │ Status,Control │ [✎][🗑] │
└──────────┴───────┴────────────────┴─────────┘
```

**Форма користувача:**
```
Username: [__________]
Password: [__________]
Role:     (●) Admin  ( ) User

Дозволені вкладки:
[✓] Status (завжди)
[✓] Control
[✓] XY Table
[ ] Settings
[ ] Admin
[ ] Logs

[Зберегти]  [Скасувати]
```

### Вкладка "Логи"

**Фільтри:**
```
Рівень: [▼ All] [▼ INFO] [▼ WARNING] [▼ ERROR]
Категорія: [▼ All] [▼ Cycle] [▼ XY] [▼ Relay]
Пошук: [________________]
```

**Опції:**
```
[✓] Auto-scroll  [✓] Auto-refresh  [Refresh] [Clear]
```

**Статистика:**
```
Total: 1234 | Info: 1000 | Warning: 200 | Error: 30 | Critical: 4
```

**Вивід логів:**
```
[2024-02-05 10:30:15] INFO [Cycle] Цикл запущено
[2024-02-05 10:30:16] INFO [XY] Moving to X:50 Y:100
[2024-02-05 10:30:18] WARNING [Sensor] area_sensor briefly triggered
[2024-02-05 10:30:20] INFO [Relay] r04_c2 ON (cylinder down)
```

---

## Desktop UI (touchdesk.py)

### Режим START

**Макет екрану:**
```
┌────────────────────┬──────────────────────────────────────────┐
│                    │                                          │
│  ВИБІР ДЕВАЙСУ     │  Девайс: MCO_BACK_M3x10                 │
│                    │  Таска: 0    Момент: 0.80 Nm            │
│  ┌──────────────┐  │                                          │
│  │MCO_BACK_M3x10│  │  Статус: Очікування ініціалізації       │
│  │ 4 гвинти    │  │                                          │
│  └──────────────┘  │  ════════════════════════════ 0%        │
│  ┌──────────────┐  │                                          │
│  │PANEL_FRONT   │  │                                          │
│  │ 6 гвинтів   │  │  ┌──────────────────────────────────────┐│
│  └──────────────┘  │  │                                      ││
│  ┌──────────────┐  │  │         ІНІЦІАЛІЗАЦІЯ               ││
│  │COVER_TOP     │  │  │                                      ││
│  │ 2 гвинти    │  │  └──────────────────────────────────────┘│
│  └──────────────┘  │                                          │
│                    │                                          │
└────────────────────┴──────────────────────────────────────────┘
```

### Режим WORK

**Макет екрану:**
```
┌───────────────────────────────────────────────────────────────┐
│  MCO_BACK_M3x10    Циклів: 15 (сер. 45с)    Гвинтів: 2/4     │
│  Таска: 0          Момент: 0.80 Nm                           │
├───────────────────────────────────────────────────────────────┤
│                                                               │
│                  Закручування позиції 2/4                     │
│                  X: 80.0  Y: 100.0                            │
│                                                               │
│  ══════════════════════════════════════════════════ 50%      │
│                                                               │
├────────────────────────────────────┬──────────────────────────┤
│                                    │                          │
│                                    │                          │
│         СТАРТ                      │        СТОП              │
│      ЗАКРУЧУВАННЯ                  │                          │
│                                    │                          │
│         (65%)                      │        (35%)             │
│                                    │                          │
└────────────────────────────────────┴──────────────────────────┘
```

### Кольорова схема (Dark Theme)

| Елемент | Колір | Hex |
|---------|-------|-----|
| Фон | Темно-сірий | #121212 |
| Картка | Сірий | #1e1e1e |
| Поле вводу | Темний | #2a2a2a |
| Рамка | Субтільний | #3a3a3a |
| Основний текст | Світло-сірий | #e0e0e0 |
| Вторинний текст | Сірий | #b0b0b0 |
| Акцент | Синій | #5a9fd4 |
| Успіх | Зелений | #6fcf97 |
| Небезпека | Червоний | #eb5757 |
| Попередження | Жовтий | #f2c94c |

---

## Редактор девайсів

### Структура девайсу

```json
{
  "key": "MCO_BACK_M3x10",
  "name": "MCO",
  "what": "Задня панель",
  "holes": 4,
  "screw_size": "M3x10",
  "task": "0",
  "torque": 0.8,
  "work_x": 50.0,
  "work_y": 100.0,
  "work_feed": 5000,
  "steps": [
    {"x": 10.0, "y": 20.0, "type": "free", "feed": 60000},
    {"x": 50.0, "y": 100.0, "type": "work", "feed": 30000},
    {"x": 80.0, "y": 100.0, "type": "work", "feed": 30000},
    {"x": 110.0, "y": 100.0, "type": "work", "feed": 30000},
    {"x": 140.0, "y": 100.0, "type": "work", "feed": 30000}
  ]
}
```

### Типи кроків

| Тип | Опис | Колір |
|-----|------|-------|
| FREE | Швидке переміщення без закручування | Сірий |
| WORK | Переміщення + закручування | Оранжевий |

### Валідація полів

| Поле | Обмеження |
|------|-----------|
| Назва | 4 символи, великі літери |
| Що крутим | Текст, опціонально |
| Кількість | 1-12 |
| Розмір | M3x6, M3x8, M3x10, M3x16 |
| Таска | 0-3 |
| Момент | 0.0-1.0 Nm |
| X | 0-220 мм |
| Y | 0-500 мм |
| Feed | 100-100000 мм/хв |

### Автогенерація ключа

```
Формат: {NAME}_{WHAT}_{SCREW_SIZE}
Приклад: MCO_BACK_M3x10
```

---

## Керування циклом

### Стани циклу

| Стан | Опис | Колір |
|------|------|-------|
| IDLE | Очікування | Сірий |
| READY | Готовий до старту | Синій |
| RUNNING | Виконується | Синій |
| PAUSED | Пауза | Жовтий |
| COMPLETED | Завершено | Зелений |
| ERROR | Помилка | Червоний |
| ESTOP | Аварійна зупинка | Червоний |

### Кнопки керування

**ІНІЦІАЛІЗАЦІЯ:**
- Доступна: девайс обрано
- Виконує: хомінг, перевірка датчиків, рух до оператора
- Після успіху: перехід до WORK режиму

**СТАРТ:**
- Доступна: система готова (READY або PAUSED)
- Виконує: цикл закручування
- Після успіху: COMPLETED

**СТОП:**
- Доступна: завжди
- Виконує: зупинка циклу, безпечне вимкнення
- Після: повернення до START режиму

**ПАУЗА:**
- Доступна: під час виконання
- Виконує: призупинення на місці
- Можна продовжити СТАРТ

### Індикація прогресу

```
Закручено: 2 / 4 гвинтів

[██████████████░░░░░░░░░░░░░░░] 50%

Поточна позиція: X: 80.0  Y: 100.0
```

---

## Ручне керування

### Джогінг XY

**Кроки:**
- 0.1 мм - точне позиціонування
- 0.5 мм - дрібне коригування
- 1 мм - стандартний крок
- 5 мм - середній крок
- 10 мм - швидке переміщення
- 50 мм - велике переміщення
- 100 мм - максимальний крок

**Швидкості:**
- 1000 мм/хв - повільна
- 3000 мм/хв - середня
- 5000 мм/хв - стандартна
- 10000 мм/хв - швидка

### Керування реле

**Режими:**
- ON - увімкнути
- OFF - вимкнути
- PULSE - імпульс заданої тривалості

**Тривалість імпульсу:**
- Мінімум: 50 мс
- Максимум: 5000 мс
- За замовчуванням: 500 мс

### Керування гальмами

| Стан | Індикація | Опис |
|------|-----------|------|
| Engaged | Червоний | Гальмо увімкнено |
| Released | Зелений | Гальмо вимкнено |

---

## Синхронізація Web/Desktop

### Механізм синхронізації

```
Desktop UI                    Server                      Web UI
    │                           │                           │
    │ POST /api/ui/state        │                           │
    │ ────────────────────────> │                           │
    │                           │                           │
    │                           │ GET /api/ui/state         │
    │                           │ <──────────────────────── │
    │                           │                           │
    │                           │ "operator": "desktop"     │
    │                           │ ────────────────────────> │
    │                           │                           │
    │                           │ Web показує:              │
    │                           │ "Desktop UI в роботі"     │
```

### Поля синхронізації

```json
{
  "operator": "desktop",
  "selected_device": "MCO_BACK_M3x10",
  "cycle_state": "RUNNING",
  "holes_completed": 2,
  "total_holes": 4,
  "current_position": {"x": 80.0, "y": 100.0},
  "initialized": true,
  "status_message": "Закручування 2/4"
}
```

---

## Обробка помилок

### Діалог світлової завіси

```
┌──────────────────────────────────────────┐
│                   ⚠                       │
│                                          │
│          СВІТЛОВА ЗАВІСА!                │
│                                          │
│   Зона безпеки заблокована.              │
│   Заберіть руки та натисніть кнопку.     │
│                                          │
│       [    ЗОНА БЕЗПЕЧНА    ]            │
│                                          │
└──────────────────────────────────────────┘
```

### Діалог E-STOP

```
┌──────────────────────────────────────────┐
│                   🛑                      │
│                                          │
│         АВАРІЙНА ЗУПИНКА!                │
│                                          │
│   Відпустіть кнопку E-STOP та            │
│   виконайте переініціалізацію.           │
│                                          │
└──────────────────────────────────────────┘
```

### Повідомлення про помилки

| Помилка | Повідомлення |
|---------|--------------|
| TORQUE_NOT_REACHED | "Момент не досягнуто. Перевірте гвинт." |
| AREA_BLOCKED | "Світлова завіса спрацювала!" |
| DRIVER_ALARM | "Аларм драйвера! Вийміть деталь." |
| XY_ERROR | "Помилка XY столу." |
| CYLINDER_TIMEOUT | "Циліндр не досяг позиції." |

---

## Клавіатурні скорочення

### Web UI

| Клавіша | Дія |
|---------|-----|
| F5 | Оновити сторінку |
| Escape | Закрити діалог |

### Desktop UI

| Клавіша | Дія |
|---------|-----|
| F11 | Повноекранний режим |
| Escape | Вихід з повноекранного |
