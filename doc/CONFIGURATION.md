# Довідник по конфігурації системи

## Огляд конфігураційних файлів

Всі конфігураційні файли знаходяться в `screwdrive/config/`:

| Файл | Формат | Призначення |
|------|--------|-------------|
| `settings.yaml` | YAML | Основні параметри системи |
| `devices.yaml` | YAML | Програми девайсів (координати гвинтів) |
| `gpio_pins.yaml` | YAML | Мапінг GPIO пінів для реле та датчиків |
| `auth.yaml` | YAML | Користувачі та автентифікація |
| `fixtures.yaml` | YAML | Визначення фікстур (пристосувань) для деталей |
| `backup_settings.json` | JSON | Резервна копія налаштувань (автоматично) |
| `cycle_history.json` | JSON | Статистика циклів (автоматично) |
| `global_cycles.txt` | Text | Глобальний лічильник закручених гвинтів |

---

## settings.yaml

Основний конфігураційний файл системи.

### Секція `motion` — параметри руху

```yaml
motion:
  steps_per_mm_x: 40.0       # Кроків на мм по осі X
  steps_per_mm_y: 40.0       # Кроків на мм по осі Y
  x_min_mm: 0.0              # Мінімальна координата X (мм)
  x_max_mm: 220.0            # Максимальна координата X (мм)
  y_min_mm: 0.0              # Мінімальна координата Y (мм)
  y_max_mm: 500.0            # Максимальна координата Y (мм)
  max_feed_mm_s: 600.0       # Максимальна швидкість (мм/с)
  max_step_hz: 30000         # Максимальна частота кроків (Гц)
  pulse_us: 10               # Тривалість імпульсу STEP (мкс)
  accel_mm_s2: 1500.0        # Прискорення (мм/с²)
  start_speed_mm_s: 5.0      # Початкова швидкість рампи (мм/с)
  homing_timeout_s: 60.0     # Таймаут хомінгу (с)
  backoff_mm: 5.0            # Відступ від кінцевика при хомінгу (мм)
  slow_speed_mm_s: 2.0       # Повільна швидкість дотику до кінцевика (мм/с)
```

| Параметр | Тип | Діапазон | Опис |
|----------|-----|----------|------|
| steps_per_mm_x/y | float | >0 | Визначається механікою (шків + мікрокрок) |
| x_max_mm | float | >0 | Робоча область по X |
| y_max_mm | float | >0 | Робоча область по Y |
| max_feed_mm_s | float | >0 | Обмеження швидкості для захисту механіки |
| accel_mm_s2 | float | >0 | Вище = швидше розгін, але більше навантаження |
| homing_timeout_s | float | >0 | Захист від зависання хомінгу |

### Секція `work_position` — позиція оператора

```yaml
work_position:
  x_mm: 5.0                  # X координата позиції оператора (мм)
  y_mm: 350.0                # Y координата позиції оператора (мм)
  feed_mm_min: 10000.0       # Швидкість руху до оператора (мм/хв)
```

Стіл повертається до цієї позиції:
- Після завершення циклу (COMPLETED)
- Після помилки моменту (PAUSED)
- Після зупинки (STOP)

### Секція `work_offset` — робочий зсув координат

```yaml
work_offset:
  x_mm: 106.5                # Зсув X (мм)
  y_mm: 104.0                # Зсув Y (мм)
```

Робочі координати = Фізичні координати - Офсет. Це дозволяє задавати координати гвинтів відносно центру фікстури, а не відносно кінцевиків.

### Секція `timing` — таймаути операцій

```yaml
timing:
  screw_down_timeout_s: 10.0       # Таймаут опускання (розширений)
  screw_up_timeout_s: 5.0          # Таймаут підняття (розширений)
  torque_timeout_s: 15.0           # Таймаут досягнення моменту
  cylinder_down_timeout_s: 3.0     # Таймаут опускання циліндра
  cylinder_up_timeout_s: 3.0       # Таймаут підняття циліндра
  vacuum_grab_delay_s: 0.5         # Затримка захоплення вакуумом
  vacuum_release_delay_s: 0.3      # Затримка відпускання вакуумом
  area_sensor_debounce_s: 0.1      # Дебаунсинг світлової завіси
  estop_debounce_s: 0.05           # Дебаунсинг E-STOP
```

| Параметр | Рекомендовано | Наслідки при перевищенні |
|----------|--------------|--------------------------|
| torque_timeout_s | 2-15с | TORQUE_NOT_REACHED помилка |
| cylinder_down_timeout_s | 3с | CYLINDER_TIMEOUT помилка |
| cylinder_up_timeout_s | 3-5с | CYLINDER_TIMEOUT помилка |
| area_sensor_debounce_s | 0.1с | Фільтрація хибних спрацювань |
| estop_debounce_s | 0.05с | Швидка реакція на E-STOP |

### Секція `cycle` — параметри циклу

```yaml
cycle:
  free_move_speed: 60000       # Швидкість FREE переміщення (мм/хв)
  work_move_speed: 30000       # Швидкість WORK переміщення (мм/хв)
  approach_speed: 10000        # Швидкість підходу (мм/хв)
  max_screw_retries: 3         # Максимум спроб подачі гвинта
  retry_delay_s: 1.0           # Затримка між спробами (с)
```

### Секція `api` — налаштування веб-сервера

```yaml
api:
  host: 0.0.0.0               # IP для прослуховування (0.0.0.0 = всі)
  port: 5000                   # Порт REST API та Web UI
  debug: false                 # Debug режим Flask (тільки для розробки!)
```

### Секція `logging` — логування

```yaml
logging:
  level: INFO                  # Рівень: DEBUG, INFO, WARNING, ERROR
  file: /var/log/screwdrive/cycle.log  # Шлях до файлу логів
  max_size_mb: 10              # Максимальний розмір файлу логу
  backup_count: 5              # Кількість ротованих копій
```

### Секція `xy_table` — з'єднання з XY столом

```yaml
xy_table:
  mode: serial                 # Режим: "serial" (через UART)
  serial_port: /dev/ttyAMA0    # Serial порт
  serial_baud: 115200          # Швидкість (бод)
  command_timeout_s: 30.0      # Таймаут виконання команди
  slave_ssh_host: 192.168.1.101  # IP Slave Pi (для SSH реконекту)
  slave_ssh_user: root         # SSH користувач Slave Pi
```

---

## devices.yaml

Визначення програм закручування для різних деталей.

### Структура

```yaml
groups:                        # Групи девайсів (для організації)
  - Motion Cam Outdoor
  - Motion Protect

devices:                       # Масив девайсів
  - key: MCO_BACK_M3x10       # Унікальний ідентифікатор
    name: MCO                  # Коротка назва (до 8 символів)
    holes: 4                   # Кількість гвинтів
    what: BACK                 # Що крутим (назва частини)
    screw_size: M3x10          # Розмір гвинта
    task: '0'                  # Задача шуруповерта (0-3)
    torque: 0.49               # Цільовий момент (Nm)
    work_x: 110.0              # X позиції оператора (мм)
    work_y: 500.0              # Y позиції оператора (мм)
    work_feed: 50000.0         # Швидкість до оператора (мм/хв)
    group: Motion Cam Outdoor  # Група
    fixture: 3SD-ST-E_MCO-P_BK-S_310  # Код фікстури
    coord_source: ''           # Джерело координат (якщо копія)
    program:                   # Масив кроків
      - type: WORK             # Тип: WORK або FREE
        x: 54.0                # X координата (робочі, мм)
        y: 28.9                # Y координата (робочі, мм)
        f: 50000.0             # Швидкість (мм/хв)
```

### Поля девайсу

| Поле | Тип | Обов'язкове | Опис |
|------|-----|-------------|------|
| key | string | Так | Унікальний ідентифікатор (генерується автоматично) |
| name | string | Так | Назва (до 8 символів) |
| holes | int | Так | Кількість гвинтів (1-12) |
| what | string | Ні | Опис деталі |
| screw_size | string | Так | Розмір: M3x6, M3x8, M3x10, M3x16 |
| task | string | Так | Задача шуруповерта: "0", "1", "2", "3" |
| torque | float | Так | Момент закручування (0.0-1.0 Nm) |
| work_x | float | Так | X позиція оператора (мм) |
| work_y | float | Так | Y позиція оператора (мм) |
| work_feed | float | Так | Швидкість повернення до оператора (мм/хв) |
| group | string | Ні | Назва групи девайсів |
| fixture | string | Ні | Код фікстури (для автовибору через сканер) |
| coord_source | string | Ні | Key іншого девайсу (копіювання координат) |
| program | array | Так | Масив кроків програми |

### Типи кроків програми

| Тип | Дія | Швидкість |
|-----|-----|-----------|
| **FREE** | Швидке переміщення без закручування | Висока (60000) |
| **WORK** | Переміщення + повний цикл закручування | Нижча (30000-50000) |

### Автогенерація ключа

```
Формат: {NAME}_{WHAT}_{SCREW_SIZE}
Приклад: MCO_BACK_M3x10
```

### Копіювання координат (`coord_source`)

Якщо `coord_source` вказує на `key` іншого девайсу, програма (координати) береться з того девайсу. Це дозволяє мати кілька девайсів з різними параметрами шуруповерта, але однаковими координатами.

---

## gpio_pins.yaml

Повне визначення GPIO пінів для Master Pi.

### Секція `relays`

```yaml
relays:
  r01_pit:
    gpio: 5                    # Номер GPIO (BCM)
    active_high: false         # false = active LOW (GPIO LOW = ON)
    description: "Живильник гвинтів"
    pulse_ms: 200              # Тривалість імпульсу за замовчуванням (мс)
```

**Всі реле мають `active_high: false`** — GPIO LOW увімкнює реле.

### Секція `sensors`

```yaml
sensors:
  area_sensor:
    gpio: 17                   # Номер GPIO (BCM)
    active_low: true           # true = GPIO LOW означає ACTIVE
    description: "Світлова завіса безпеки"
    pull_up: true              # Внутрішній pull-up резистор
```

**Виняток:** `emergency_stop` має `active_low: false` (GPIO HIGH = натиснуто).

### Секція `logic`

```yaml
logic:
  endstop_active_low: true     # Кінцевики: LOW = спрацьовано
  relay_active_high: false     # Реле: LOW = увімкнено
  step_pulse_active_low: true  # Імпульс STEP: LOW = крок
  step_idle_level: 1           # Рівень STEP у стані спокою
```

---

## auth.yaml

Конфігурація автентифікації та користувачів.

### Структура

```yaml
secret_key: "your-secret-key"  # Ключ для підпису сесій (ЗМІНИТИ!)

session:
  remember_me_days: 30         # Термін "запам'ятати мене" (днів)
  timeout_minutes: 480         # Таймаут сесії (хвилин, 480 = 8 год)

available_tabs:                # Доступні вкладки в системі
  - status
  - control
  - xy
  - settings
  - admin
  - logs

users:
  admin:
    password_hash: "$2b$12$..."  # bcrypt хеш пароля
    role: admin                  # Роль: admin або user
    allowed_tabs:                # Дозволені вкладки
      - status
      - control
      - xy
      - settings
      - admin
      - logs
```

### Ролі

| Роль | Опис | Типові вкладки |
|------|------|----------------|
| `admin` | Повний доступ | Всі |
| `user` | Обмежений доступ | status, control, xy |

### Керування паролями

Паролі зберігаються у вигляді bcrypt хешу. Створення нового користувача виконується через Web UI (вкладка Адмін) або API (`POST /api/users`).

**Увага:** `secret_key` треба замінити на унікальне значення при розгортанні!

---

## fixtures.yaml

Визначення фікстур (пристосувань) для деталей. Використовується для автоматичного вибору девайсу через сканер штрих-кодів.

### Структура

```yaml
fixtures:
  - code: 3SD-ST-E_MCO-P_BK-S_310    # Унікальний код фікстури
    base_group: Motion Cam Outdoor     # Група продуктів
    qr_code: MCO_BK_001               # QR/штрих-код на фікстурі
    scan_x: 110.0                      # X позиція для сканування (мм)
    scan_y: 320.0                      # Y позиція для сканування (мм)
    scan_feed: 20000.0                 # Швидкість руху до позиції сканування
```

### Зв'язок з девайсами

Поле `fixture` в `devices.yaml` відповідає полю `code` в `fixtures.yaml`. Коли сканер зчитує штрих-код фікстури, система знаходить відповідний девайс і автоматично його обирає.

---

## cycle_history.json

Автоматично генерований файл з статистикою циклів.

```json
{
  "total_cycles": 1234,
  "total_screws": 5678,
  "last_cycle_time": "2026-02-12T10:30:00",
  "errors": {
    "torque_not_reached": 15,
    "screw_not_detected": 3,
    "cylinder_timeout": 1
  },
  "device_stats": {
    "MCO_BACK_M3x10": {
      "cycles": 500,
      "screws": 2000,
      "errors": 5
    }
  }
}
```

---

## global_cycles.txt

Простий текстовий файл з одним числом — загальна кількість закручених гвинтів за весь час роботи системи.

```
5678
```

---

## Рекомендації з конфігурації

### При першому запуску

1. **Обов'язково змініть** `secret_key` в `auth.yaml`
2. Перевірте `serial_port` в `settings.yaml` — має відповідати фізичному підключенню
3. Перевірте GPIO піни в `gpio_pins.yaml` — мають відповідати розведенню плати
4. Встановіть правильний `work_offset` після калібрування

### При додаванні нового девайсу

1. Виконайте хомінг (G28)
2. Використайте джогінг для знаходження координат кожного гвинта
3. Запишіть координати як WORK кроки
4. Додайте FREE кроки для оптимізації траєкторії
5. Виконайте тестовий цикл без деталі

### При зміні обладнання

1. Оновіть `steps_per_mm` якщо змінився крок шківа або мікрокрок
2. Оновіть `x_max_mm` / `y_max_mm` якщо змінилась робоча область
3. Перевірте всі GPIO піни якщо змінилось підключення
4. Перезапустіть обидва Pi після змін
